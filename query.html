<script>
        document.addEventListener('DOMContentLoaded', function() {
            // *** ğŸš¨ JSON ç¶²å€ (è«‹ç¢ºä¿æ­¤ç¶²å€ç‚ºæœ‰æ•ˆé€£çµ) ***
            // ç”±æ–¼ç”¨æˆ¶æä¾›çš„ JSON ç¶²å€å¯èƒ½å†æ¬¡å¤±æ•ˆï¼Œé€™è£¡ä½¿ç”¨å‰ä¸€å€‹æœ‰æ•ˆç¶²å€ï¼Œè«‹è‡ªè¡Œæ›¿æ›ç‚ºæœ€æ–°çš„æœ‰æ•ˆç¶²å€
            const JSON_URL = 'https://raw.githubusercontent.com/augustttatf/bctp/refs/heads/main/meowmeowmeow.json'; 
            
            const filterContainer = document.getElementById('behavior-filters');
            const resultsArea = document.getElementById('results-area');
            const loadingMessage = document.getElementById('loading-message');
            const checkboxes = filterContainer.querySelectorAll('input[type="checkbox"]');
            
            let lawData = { related_statutes_segmented: [], LawType_Mapping: {} }; 

            // ã€å„ªåŒ–é»ã€‘ï¼šé¿å… localStorage æ±™æŸ“ï¼Œåªåœ¨æœ‰å‹¾é¸æ™‚è¨­å®š
            // localStorage.removeItem('selectedBehaviors'); 

            // è¼”åŠ©å‡½æ•¸ï¼šå–å¾— LawType é¡¯ç¤ºåç¨±å’Œæ¨™ç±¤
            function getLawTypeLabel(law) {
                // ã€ä¿®å¾©é»ã€‘ï¼šç¢ºä¿ LawType_Mapping å­˜åœ¨ä¸”æœ‰å°æ‡‰çš„ key
                const lawTypeKey = law.LawType != null ? law.LawType.toString() : '';
                let lawTypeLabel = lawData.LawType_Mapping[lawTypeKey] || 'ç›¸é—œæ³•æ¢';
                
                if (law.LawType === 0) {
                    return `ğŸ›¡ï¸ ${lawTypeLabel}`; // é€šç”¨æ³•æ¢
                } else if (law.LawType === 5) {
                    return `ğŸ¤ ${lawTypeLabel}`; // æ³•æ¢è£œå…… (å”å•†/è¼•å¾®)
                } 
                
                // é‡å° LawType 1-4 çš„è¡Œç‚º
                if (law.ReplenishType === 1) {
                    return `âš  ${lawTypeLabel} (å»ºè­°å’Œè§£/è³ å„Ÿ)`; 
                }
                return `ğŸ”— ${lawTypeLabel}`; // é è¨­æ¨™ç±¤
            }

            async function loadLawData() {
                // ... (è¼‰å…¥è³‡æ–™çš„é‚è¼¯ä¿æŒä¸è®Šï¼Œå› ç‚ºé€™éƒ¨åˆ†ç›¸å°æ¨™æº–)
                try {
                    const response = await fetch(JSON_URL); 
                    
                    if (!response.ok) {
                        const errorStatus = response.status;
                        let errorMessage = `è¼‰å…¥å¤±æ•—ï¼šHTTP ç‹€æ…‹ç¢¼ ${errorStatus}ã€‚`;
                        if (errorStatus === 404) {
                            errorMessage += 'éŒ¯èª¤ï¼šæª”æ¡ˆä¸å­˜åœ¨æˆ–ç¶²å€éŒ¯èª¤ã€‚';
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const textData = await response.text();
                    let fullData;
                    try {
                        fullData = JSON.parse(textData);
                    } catch (e) {
                        throw new Error("JSON èªæ³•éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹ã€‚");
                    }

                    lawData = fullData;
                    
                    loadingMessage.textContent = 'âœ”ï¸ æ³•å¾‹è³‡æ–™è¼‰å…¥æˆåŠŸã€‚è«‹å‹¾é¸å·¦å´è¡Œç‚ºã€‚';
                    loadingMessage.style.color = '#28a745';
                    updateResults(); 

                } catch (error) {
                    console.error('è¼‰å…¥æ³•å¾‹è³‡æ–™å¤±æ•—:', error);
                    loadingMessage.innerHTML = `âŒ è¼‰å…¥æ³•å¾‹è³‡æ–™å¤±æ•—ï¼š<br><strong>${error.message}</strong><br>è«‹æª¢æŸ¥ JSON ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚`;
                    loadingMessage.style.color = 'red';
                }
            }


            // è¼”åŠ©å‡½æ•¸ï¼šå‰µå»ºé¡¯ç¤ºç”¨çš„æ³•æ¢å¡ç‰‡ (è™•ç†å»é‡è¤‡å¾Œçš„è³‡æ–™çµæ§‹)
            function createLawCard(lawGroup) {
                const card = document.createElement('div');
                
                // æ±ºå®šå¡ç‰‡æ¨£å¼
                const isSupplementCategory = lawGroup.isSupplementCategory;
                card.className = `law-card ${isSupplementCategory ? 'replenish-content' : ''}`; 
                
                // 1. ä¸»è¦æ¨™é¡Œå’Œæ¢æ–‡å…§å®¹
                let html = `<h3 class="law-num-title">${lawGroup.LawNum || 'ç„¡æ¢æ¬¾è™Ÿ'}</h3>`;
                html += `<p class="law-details"><strong>æ¢æ–‡è©³æƒ…ï¼š</strong> ${lawGroup.LawDetails || 'ç„¡è©³æƒ…'}</p>`;

                // 2. å½™æ•´ç›¸é—œè¡Œç‚ºå’Œå‚™è¨» (å»é‡è¤‡)
                if (lawGroup.combinedNotes.length > 0) {
                    html += '<ul class="combined-relevance-list">';
                    
                    const isGeneralOrSupplement = lawGroup.LawType === 0 || lawGroup.LawType === 5;

                    lawGroup.combinedNotes.forEach(note => {
                        // ã€ä¿®å¾©/å„ªåŒ–é»ã€‘ï¼šLawType 0 (é€šç”¨) æˆ– LawType 5 (æ³•æ¢è£œå……) çš„æ¢æ–‡ï¼Œåªéœ€è¦é¡¯ç¤ºä¸€æ¬¡é€šç”¨æ¨™ç±¤
                        // è€Œ LawType 1-4 çš„è¡Œç‚ºï¼Œé¡¯ç¤ºç‰¹å®šçš„è¡Œç‚ºæ¨™ç±¤å’Œå‚™è¨»
                        
                        const specificLawTypeLabel = getLawTypeLabel(note);
                        
                        // LawType 0/5 çš„æ³•æ¢ï¼Œåªé¡¯ç¤ºå…¶æœ¬èº«çš„å‚™è¨»
                        if (isGeneralOrSupplement) {
                            // ç”±æ–¼ combinedNotes å°æ–¼ LawType 0/5 åªæœ‰ä¸€æ¢ï¼Œå› æ­¤ç›´æ¥é¡¯ç¤º
                            html += `<li><strong>${specificLawTypeLabel}ï¼š</strong> ${lawGroup.RelevanceNote || 'ç„¡ç›¸é—œæ€§èªªæ˜'}</li>`;
                        } else {
                            // é‡å° LawType 1-4 çš„ç‰¹å®šè¡Œç‚ºï¼Œé¡¯ç¤ºè¡Œç‚ºæ¨™ç±¤å’Œå‚™è¨»
                             html += `<li><strong>${specificLawTypeLabel}ï¼š</strong> ${note.RelevanceNote || 'ç„¡ç›¸é—œæ€§èªªæ˜'}</li>`;
                        }
                    });

                    html += '</ul>';
                }
                
                card.innerHTML = html;
                return card;
            }


            function updateResults() {
                resultsArea.innerHTML = ''; 
                const selectedLawTypes = new Set(); 
                let checkedBehaviorNames = []; 
                let groupedLaws = {}; 
                
                const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
                
                if (checkedBoxes.length === 0) {
                    // ã€å„ªåŒ–é»ã€‘ï¼šå¦‚æœæ²’æœ‰å‹¾é¸ï¼Œæ¢å¾©åˆå§‹çš„è¼‰å…¥æˆåŠŸæç¤º
                    resultsArea.appendChild(loadingMessage);
                    if (loadingMessage.textContent.includes('è¼‰å…¥æˆåŠŸ')) {
                        loadingMessage.textContent = 'âœ”ï¸ æ³•å¾‹è³‡æ–™è¼‰å…¥æˆåŠŸã€‚è«‹å‹¾é¸å·¦å´è¡Œç‚ºã€‚';
                    }
                    localStorage.removeItem('selectedBehaviors'); 
                    return;
                }
                
                checkedBoxes.forEach(cb => {
                    // ã€ä¿®å¾©é»ã€‘ï¼šç¢ºä¿ LawType è½‰æ›æ­£ç¢ºï¼Œä¸¦åªè™•ç† 1-4
                    const type = parseInt(cb.getAttribute('data-type'));
                    if (type >= 1 && type <= 4) {
                        selectedLawTypes.add(type);
                    }
                    checkedBehaviorNames.push(`* ${cb.getAttribute('data-name')}`); 
                });
                
                const selectedBehaviors = checkedBehaviorNames.join('\n'); 
                localStorage.setItem('selectedBehaviors', selectedBehaviors);

                if (loadingMessage) loadingMessage.remove(); 
                
                // 1. ç¯©é¸ã€åˆ†çµ„ä¸¦å»é‡è¤‡æ³•æ¢
                lawData.related_statutes_segmented.forEach(law => {
                    const isBehaviorLaw = law.LawType >= 1 && law.LawType <= 4;
                    const isGeneralOrSupplementLaw = law.LawType === 0 || law.LawType === 5;
                    
                    // ç¢ºä¿åªè™•ç†é¸ä¸­çš„è¡Œç‚º LawType (1-4)ï¼Œæˆ–é€šç”¨çš„ LawType (0, 5)
                    if ( (isBehaviorLaw && selectedLawTypes.has(law.LawType)) || isGeneralOrSupplementLaw) {
                        
                        const key = law.LawNum;
                        
                        if (!groupedLaws[key]) {
                            // åˆå§‹åŒ–æ³•æ¢ç¾¤çµ„
                            groupedLaws[key] = {
                                LawNum: law.LawNum,
                                LawDetails: law.LawDetails,
                                LawType: law.LawType, 
                                RelevanceNote: law.RelevanceNote, 
                                isSupplementCategory: law.LawType === 5 || law.ReplenishType === 1,
                                combinedNotes: []
                            };
                        }
                        
                        // LawType 1-4 çš„è™•ç†
                        if (isBehaviorLaw) {
                            const alreadyExists = groupedLaws[key].combinedNotes.some(note => note.LawType === law.LawType);
                            
                            if (!alreadyExists) {
                                // ã€ä¿®å¾©é»ã€‘ï¼šå°æ–¼ LawType 1-4ï¼Œå°‡å…¶å®Œæ•´çš„å±¬æ€§ (å« ReplenishType) åŠ å…¥ combinedNotes
                                groupedLaws[key].combinedNotes.push({
                                    LawType: law.LawType,
                                    ReplenishType: law.ReplenishType,
                                    RelevanceNote: law.RelevanceNote
                                });
                            }
                        } 
                        // LawType 0/5 çš„è™•ç†
                        else if (isGeneralOrSupplementLaw) {
                            // ã€ä¿®å¾©é»ã€‘ï¼šLawType 0/5 åªéœ€åŠ å…¥ä¸€æ¬¡ï¼Œä¸”åªåŒ…å« LawType æœ¬èº«
                             const alreadyExists = groupedLaws[key].combinedNotes.some(note => note.LawType === law.LawType);

                            if (!alreadyExists) {
                                groupedLaws[key].combinedNotes.push({
                                    LawType: law.LawType,
                                    ReplenishType: law.ReplenishType, // LawType 5 å¯èƒ½æœ‰ ReplenishType
                                    RelevanceNote: law.RelevanceNote
                                });
                            }
                        }

                        // å¦‚æœé€™å€‹ LawNum ä¾†æºæ–¼ä»»ä½• ReplenishType 1 æˆ– LawType 5ï¼Œå‰‡å°‡æ•´å€‹ç¾¤çµ„è¨­ç‚º Supplementary
                        if (law.LawType === 5 || law.ReplenishType === 1) {
                            groupedLaws[key].isSupplementCategory = true;
                        }
                    }
                });
                
                // 2. å°‡åˆ†çµ„çµæœè½‰æ›ç‚ºé™£åˆ—ï¼Œä¸¦æŒ‰åˆ†é¡åˆ†çµ„
                const uniqueLawArray = Object.values(groupedLaws);
                
                // ã€å„ªåŒ–é»ã€‘ï¼šæ’åºï¼Œå°‡ ReplenishType: 0 (æ ¸å¿ƒ) å’Œ LawType: 0 (é€šç”¨) å„ªå…ˆé¡¯ç¤º
                let coreLaws = uniqueLawArray.filter(lawGroup => !lawGroup.isSupplementCategory);
                let supplementLaws = uniqueLawArray.filter(lawGroup => lawGroup.isSupplementCategory);

                // --- é¡¯ç¤ºæ ¸å¿ƒæ³•æ¢ (ç‰¹å®šè¡Œç‚º ReplenishType: 0 å’Œ LawType: 0) ---
                const mainTitle = document.createElement('h3');
                mainTitle.textContent = "ğŸ›¡ï¸ æ ¸å¿ƒèˆ‡ç‰¹å®šè¡Œç‚ºç›¸é—œæ³•æ¢ï¼š";
                resultsArea.appendChild(mainTitle);
                
                if (coreLaws.length === 0) {
                    const note = document.createElement('p');
                    note.className = 'note';
                    note.textContent = 'ç„¡ç‰¹å®šè¡Œç‚ºçš„æ ¸å¿ƒæ³•æ¢ã€‚';
                    resultsArea.appendChild(note);
                } else {
                    coreLaws.forEach(lawGroup => resultsArea.appendChild(createLawCard(lawGroup)));
                }


                // --- é¡¯ç¤ºå”å•†èˆ‡è¼•å¾®è™•åˆ† (åˆä½µé¡¯ç¤º ReplenishType: 1 å’Œ LawType: 5) ---
                if (supplementLaws.length > 0) {
                    const combinedTitle = document.createElement('h3');
                    combinedTitle.textContent = "âš–ï¸ å”å•†ã€è³ å„Ÿèˆ‡æƒ…ç¯€è¼•å¾®è™•åˆ†ï¼š";
                    resultsArea.appendChild(combinedTitle);
                    
                    supplementLaws.forEach(lawGroup => resultsArea.appendChild(createLawCard(lawGroup)));
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateResults);
            });
            
            // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­çš„è¡Œç‚ºï¼Œå¦‚æœæœ‰å‰‡è§¸ç™¼æ›´æ–°
            loadLawData();
        });
    </script>
