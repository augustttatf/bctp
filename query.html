<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCTP - è¡Œç‚ºå¾ŒæœæŸ¥è©¢</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        #main-content-wrapper {
            display: none; 
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">
</head>
<body>
    <header>
        <div class="container">
            <h1>BCTP</h1>
            <p>éœ¸å‡Œè¡Œç‚ºå¾Œæœé€æ˜åŒ–è³‡è¨Šå¹³å°</p>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="main-content-wrapper"> 
                
                <div class="main-layout-grid"> 
                    
                    <div class="filter-panel">
                        <h2>æ­¥é©Ÿä¸€ï¼šè¡Œç‚ºå‹¾é¸</h2>
                        <p>å‹¾é¸è§¸ç™¼æ³•å¾‹å¾Œæœçš„è¡Œç‚ºï¼ŒæŸ¥çœ‹å°æ‡‰çš„æ³•å¾‹å¾Œæœèˆ‡æ¡ˆä¾‹ã€‚</p>

                        <div class="checkbox-group" id="behavior-filters">
                            <label><input type="checkbox" name="behavior" value="physical-injury" data-type="1" data-name="è‚¢é«”æ¨æ‰“ / é€ æˆè¼•å‚·"> è‚¢é«”æ¨æ‰“ / é€ æˆè¼•å‚·</label>
                            <label><input type="checkbox" name="behavior" value="online-slander" data-type="2" data-name="ç¶²è·¯æ•£å¸ƒè¬ è¨€ / æå®³åè­½"> ç¶²è·¯æ•£å¸ƒè¬ è¨€ / æå®³åè­½</label>
                            <label><input type="checkbox" name="behavior" value="money-extortion" data-type="3" data-name="å¨è„…å–è²¡ / ææ¯€æ”¯ä»˜é‡‘éŒ¢"> å¨è„…å–è²¡ / ææ¯€æ”¯ä»˜é‡‘éŒ¢</label>
                            <label><input type="checkbox" name="behavior" value="psychological-damage" data-type="4" data-name="å¯†é›†è¨Šæ¯é¨·æ“¾ / é€ æˆç²¾ç¥å£“åŠ›"> å¯†é›†è¨Šæ¯é¨·æ“¾ / é€ æˆç²¾ç¥å£“åŠ›</label>
                        </div>
                    </div>

                    <div class="results-panel">
                        <h2>æ­¥é©ŸäºŒï¼šå¾Œæœè­¦ç¤º (å³æ™‚äº’å‹•)</h2>
                        <p>è«‹åœ¨ä¸Šæ–¹å‹¾é¸è¡Œç‚ºæ¨™ç±¤ï¼Œçµæœå°‡å³æ™‚é¡¯ç¤ºç›¸é—œæ³•å¾‹æ¢æ–‡ã€‚</p>
                        <div id="results-area">
                            </div>
                    </div>
                    
                    <div class="case-panel">
                        <h2>æ­¥é©Ÿä¸‰ï¼šç›¸é—œæ¡ˆä¾‹</h2>
                        <p>è«‹åœ¨ä¸Šæ–¹å‹¾é¸è¡Œç‚ºæ¨™ç±¤ï¼ŒæŸ¥çœ‹ç›¸é—œæ–°èæ¡ˆä¾‹ã€‚</p>
                        <div id="case-area">
                             </div>
                    </div>
                    
                </div> 

                <div class="button-footer">
                    <a href="form.html" id="next-form-button" class="submit-button">ä¸‹ä¸€æ­¥ï¼šåæ€è¡¨å–® &rarr;</a>
                </div>
            </div>

            <p id="initial-loading-status" style="text-align:center; font-size:1.1em;" class="loading-message">è¼‰å…¥æ³•å¾‹è³‡æ–™ä¸­...</p>
        </div>
    </main>
    
    <footer>
        <p>BCTP (Bullying Consequence Transparency Platform)</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // *** ğŸš¨ æ•¸æ“šæºï¼šå…©å€‹ JSON ç¶²å€ ***
            const STATUTES_URL = 'https://raw.githubusercontent.com/augustttatf/bctp/refs/heads/main/meowmeowmeow.json';
            const CASES_URL = 'https://raw.githubusercontent.com/augustttatf/bctp/refs/heads/main/newjeans.json';
            
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const initialLoadingStatus = document.getElementById('initial-loading-status');
            const filterContainer = document.getElementById('behavior-filters');
            const resultsArea = document.getElementById('results-area');
            const caseArea = document.getElementById('case-area'); 
            const checkboxes = filterContainer.querySelectorAll('input[type="checkbox"]');
            
            // æç¤ºè¨Šæ¯å¸¸æ•¸
            const FATAL_ERROR_MESSAGE = 'ç¶²ç«™éŒ¯èª¤ï¼šæ ¸å¿ƒè³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå³å°‡è¿”å›é¦–é ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚';

            let lawData = { related_statutes_segmented: [], LawType_Mapping: {}, cases: [] }; 

            // è¼”åŠ©å‡½æ•¸ï¼šå–å¾— LawType é¡¯ç¤ºåç¨±å’Œæ¨™ç±¤
            function getLawTypeLabel(law) {
                const lawTypeKey = law.LawType != null ? law.LawType.toString() : '';
                let lawTypeLabel = lawData.LawType_Mapping[lawTypeKey] || 'ç›¸é—œæ³•æ¢';
                
                if (law.LawType === 0) {
                    return `ğŸ›¡ï¸ ${lawTypeLabel}`;
                } else if (law.LawType === 5) {
                    return `ğŸ¤ ${lawTypeLabel}`;
                } 
                
                if (law.ReplenishType === 1) {
                    return `âš  ${lawTypeLabel} (å»ºè­°å’Œè§£/è³ å„Ÿ)`; 
                }
                return `ğŸ”— ${lawTypeLabel}`;
            }

            // ã€è¼‰å…¥æ•¸æ“šçš„æ ¸å¿ƒé‚è¼¯ - å«å®¹éŒ¯è·³è½‰ã€‘
            async function loadLawData() {
                try {
                    const [statutesResponse, casesResponse] = await Promise.all([
                        fetch(STATUTES_URL),
                        fetch(CASES_URL)
                    ]);
                    
                    if (!statutesResponse.ok) {
                        throw new Error(`æ³•æ¢æª”æ¡ˆè¼‰å…¥å¤±æ•— (HTTP ${statutesResponse.status})`);
                    }
                    if (!casesResponse.ok) {
                        throw new Error(`æ¡ˆä¾‹æª”æ¡ˆè¼‰å…¥å¤±æ•— (HTTP ${casesResponse.status})`);
                    }
                    
                    const statutesData = await statutesResponse.json();
                    const casesData = await casesResponse.json();

                    lawData.related_statutes_segmented = statutesData.related_statutes_segmented || [];
                    lawData.LawType_Mapping = statutesData.LawType_Mapping || {};
                    lawData.cases = casesData.cases || casesData || []; 

                    // è¼‰å…¥æˆåŠŸï¼šç§»é™¤åˆå§‹è¼‰å…¥è¨Šæ¯ï¼Œé¡¯ç¤ºä¸»è¦å…§å®¹
                    if (initialLoadingStatus) initialLoadingStatus.remove();
                    if (mainContentWrapper) {
                        mainContentWrapper.style.display = 'block'; 
                    }
                    
                    updateResults(); 

                } catch (error) {
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼šé¡¯ç¤ºéŒ¯èª¤ä¸¦è·³è½‰å›é¦–é 
                    console.error('è¼‰å…¥æ³•å¾‹è³‡æ–™å¤±æ•—:', error);
                    
                    const detailedError = `âŒ ${FATAL_ERROR_MESSAGE}\nè©³ç´°éŒ¯èª¤: ${error.message}`;

                    if (initialLoadingStatus) {
                        initialLoadingStatus.innerHTML = detailedError.replace(/\n/g, '<br>');
                        initialLoadingStatus.style.color = 'red';
                    }
                    
                    alert(FATAL_ERROR_MESSAGE);

                    // è·³è½‰å›é¦–é 
                    window.location.href = 'index.html'; 
                }
            }


            // è¼”åŠ©å‡½æ•¸ï¼šå‰µå»ºé¡¯ç¤ºç”¨çš„æ³•æ¢å¡ç‰‡
            function createLawCard(lawGroup) {
                const card = document.createElement('div');
                const isSupplementCategory = lawGroup.isSupplementCategory;
                card.className = `law-card ${isSupplementCategory ? 'replenish-content' : ''}`; 
                
                let html = `<h3 class="law-num-title">${lawGroup.LawNum || 'ç„¡æ¢æ¬¾è™Ÿ'}</h3>`;
                html += `<p class="law-details"><strong>æ¢æ–‡è©³æƒ…ï¼š</strong> ${lawGroup.LawDetails || 'ç„¡è©³æƒ…'}</p>`;

                if (lawGroup.combinedNotes.length > 0) {
                    html += '<ul class="combined-relevance-list">';
                    const isGeneralOrSupplement = lawGroup.LawType === 0 || lawGroup.LawType === 5;
                    const uniqueNotes = [...new Map(lawGroup.combinedNotes.map(item => [item.LawType, item])).values()];

                    uniqueNotes.forEach(note => {
                        const specificLawTypeLabel = getLawTypeLabel(note);
                        
                        if (isGeneralOrSupplement) {
                            html += `<li><strong>${specificLawTypeLabel}ï¼š</strong> ${lawGroup.RelevanceNote || 'ç„¡ç›¸é—œæ€§èªªæ˜'}</li>`;
                        } else {
                             html += `<li><strong>${specificLawTypeLabel}ï¼š</strong> ${note.RelevanceNote || 'ç„¡ç›¸é—œæ€§èªªæ˜'}</li>`;
                        }
                    });
                    html += '</ul>';
                }
                
                card.innerHTML = html;
                return card;
            }

            // è¼”åŠ©å‡½æ•¸ï¼šå‰µå»ºæ¡ˆä¾‹å¡ç‰‡
            function createCaseCard(caseItem) {
                const card = document.createElement('div');
                card.className = 'case-card';

                let html = `<h4 class="case-title">${caseItem.casename || 'ç„¡æ¡ˆä¾‹æ¨™é¡Œ'}</h4>`;
                html += `<p class="case-content"><strong>äº‹ä»¶ç¶“éï¼š</strong> ${caseItem.newscontent || 'ç„¡äº‹ä»¶ç¶“é'}</p>`;
                
                if (caseItem.source) {
                    html += `<p class="case-source"><strong>æ–°èä¾†æºï¼š</strong> <a href="${caseItem.source}" target="_blank" rel="noopener noreferrer">é»æ“ŠæŸ¥çœ‹</a></p>`;
                }

                if (caseItem.videoconnection) {
                    const youtubeMatch = caseItem.videoconnection.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|\w+\?v=)|youtu\.be\/)(\w+)/);
                    const vimeoMatch = caseItem.videoconnection.match(/(?:vimeo\.com\/)(\d+)/);

                    if (youtubeMatch && youtubeMatch[1]) {
                        html += `
                            <div class="video-container">
                                <iframe 
                                    src="https://www.youtube.com/embed/${youtubeMatch[1]}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen
                                ></iframe>
                            </div>
                        `;
                    } else if (vimeoMatch && vimeoMatch[1]) {
                        html += `
                            <div class="video-container">
                                <iframe 
                                    src="https://player.vimeo.com/video/${vimeoMatch[1]}" 
                                    frameborder="0" 
                                    allow="autoplay; fullscreen; picture-in-picture" 
                                    allowfullscreen
                                ></iframe>
                            </div>
                        `;
                    } else {
                        html += `<p class="case-video"><strong>ç›¸é—œå½±ç‰‡ï¼š</strong> <a href="${caseItem.videoconnection}" target="_blank" rel="noopener noreferrer">é»æ“ŠæŸ¥çœ‹å½±ç‰‡</a></p>`;
                    }
                }
                
                card.innerHTML = html;
                return card;
            }


            function updateResults() {
                resultsArea.innerHTML = ''; 
                caseArea.innerHTML = ''; 
                
                const selectedLawTypes = new Set(); 
                let checkedBehaviorNames = []; 
                let groupedLaws = {}; 
                
                const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
                
                if (checkedBoxes.length === 0) {
                    // æœªå‹¾é¸ä»»ä½•è¡Œç‚ºæ™‚ï¼Œæ¸…ç©ºçµæœå€å’Œæ¡ˆä¾‹å€ã€‚
                    localStorage.removeItem('selectedBehaviors'); 
                    return;
                }
                
                checkedBoxes.forEach(cb => {
                    const type = parseInt(cb.getAttribute('data-type'));
                    if (type >= 1 && type <= 4) {
                        selectedLawTypes.add(type);
                    }
                    checkedBehaviorNames.push(`* ${cb.getAttribute('data-name')}`); 
                });
                
                const selectedBehaviors = checkedBehaviorNames.join('\n'); 
                localStorage.setItem('selectedBehaviors', selectedBehaviors);
                
                // 1. ç¯©é¸æ³•æ¢ (é‚è¼¯ä¸è®Š)
                lawData.related_statutes_segmented.forEach(law => {
                    const isBehaviorLaw = law.LawType >= 1 && law.LawType <= 4;
                    const isGeneralOrSupplementLaw = law.LawType === 0 || law.LawType === 5;
                    
                    if ( (isBehaviorLaw && selectedLawTypes.has(law.LawType)) || isGeneralOrSupplementLaw) {
                        
                        const key = law.LawNum;
                        
                        if (!groupedLaws[key]) {
                            groupedLaws[key] = {
                                LawNum: law.LawNum,
                                LawDetails: law.LawDetails,
                                LawType: law.LawType, 
                                RelevanceNote: law.RelevanceNote, 
                                isSupplementCategory: law.LawType === 5 || law.ReplenishType === 1,
                                combinedNotes: []
                            };
                        }
                        
                        const currentLawType = law.LawType;
                        const alreadyExists = groupedLaws[key].combinedNotes.some(note => note.LawType === currentLawType);

                        if (!alreadyExists) {
                            groupedLaws[key].combinedNotes.push({
                                LawType: currentLawType,
                                ReplenishType: law.ReplenishType, 
                                RelevanceNote: law.RelevanceNote
                            });
                        }
                        
                        if (law.LawType === 5 || law.ReplenishType === 1) {
                            groupedLaws[key].isSupplementCategory = true;
                        }
                    }
                });
                
                // 2. é¡¯ç¤ºæ³•æ¢çµæœ (é‚è¼¯ä¸è®Š)
                const uniqueLawArray = Object.values(groupedLaws);
                
                let coreLaws = uniqueLawArray.filter(lawGroup => !lawGroup.isSupplementCategory);
                let supplementLaws = uniqueLawArray.filter(lawGroup => lawGroup.isSupplementCategory);


                const mainTitle = document.createElement('h3');
                mainTitle.textContent = "ğŸ›¡ï¸ æ ¸å¿ƒèˆ‡ç‰¹å®šè¡Œç‚ºç›¸é—œæ³•æ¢ï¼š";
                resultsArea.appendChild(mainTitle);
                
                if (coreLaws.length === 0) {
                    const note = document.createElement('p');
                    note.className = 'note';
                    note.textContent = 'ç„¡æ ¸å¿ƒæ³•æ¢ã€‚';
                    resultsArea.appendChild(note);
                } else {
                    coreLaws.forEach(lawGroup => resultsArea.appendChild(createLawCard(lawGroup)));
                }

                if (supplementLaws.length > 0) {
                    const combinedTitle = document.createElement('h3');
                    combinedTitle.textContent = "âš–ï¸ å”å•†ã€è³ å„Ÿèˆ‡æƒ…ç¯€è¼•å¾®è™•åˆ†ï¼š";
                    resultsArea.appendChild(combinedTitle);
                    
                    supplementLaws.forEach(lawGroup => resultsArea.appendChild(createLawCard(lawGroup)));
                }
                
                
                // 3. ç¯©é¸ä¸¦é¡¯ç¤ºæ¡ˆä¾‹ (ã€é—œéµä¿®å¾©é»ã€‘: è½‰æ›ç‚ºæ•¸å­—é€²è¡Œæ¯”å°)
                const selectedNewsTypes = Array.from(selectedLawTypes); 

                const casesToDisplay = lawData.cases.filter(caseItem => {
                    // ğŸš¨ ç¢ºä¿ NewsType è¢«è½‰æ›ç‚ºæ•¸å­—
                    const caseNewsType = parseInt(caseItem.NewsType);
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—ï¼Œä¸¦åŒ…å«åœ¨é¸ä¸­çš„ LawType ä¸­
                    return !isNaN(caseNewsType) && selectedNewsTypes.includes(caseNewsType);
                });

                if (casesToDisplay.length === 0) {
                    const note = document.createElement('p');
                    note.className = 'note';
                    note.textContent = 'ç›®å‰æ²’æœ‰èˆ‡æ‰€é¸è¡Œç‚ºç›¸é—œçš„å…¬é–‹æ¡ˆä¾‹ã€‚';
                    caseArea.appendChild(note);
                } else {
                    casesToDisplay.forEach(caseItem => caseArea.appendChild(createCaseCard(caseItem)));
                }
                
                if (coreLaws.length === 0 && supplementLaws.length === 0 && casesToDisplay.length === 0 && checkedBoxes.length > 0) {
                    // å¦‚æœå‹¾é¸äº†ä½†æ²’æ‰¾åˆ°ä»»ä½•çµæœï¼Œæä¾›ä¸€å€‹ç¸½çµæç¤º
                    resultsArea.innerHTML = '<p class="note">æœªæ‰¾åˆ°ç›¸é—œæ³•å¾‹æ¢æ–‡å’Œæ¡ˆä¾‹ã€‚</p>';
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateResults);
            });
            
            // é–‹å§‹è¼‰å…¥è³‡æ–™
            loadLawData();
        });
    </script>
</body>
</html>
