<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BCTP - è¡Œç‚ºå¾ŒæœæŸ¥è©¢</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">
</head>
<body>
<header>
<div class="container">
<h1>BCTP</h1>
<p>éœ¸å‡Œè¡Œç‚ºå¾Œæœé€æ˜åŒ–è³‡è¨Šå¹³å°</p>
</div>
</header>

<main>
<div class="container">
<div id="main-content-wrapper" style="display:none;">
<div class="main-layout-grid">
  <div class="filter-panel">
    <h2>æ­¥é©Ÿä¸€ï¼šè¡Œç‚ºå‹¾é¸</h2>
    <p>å‹¾é¸è§¸ç™¼æ³•å¾‹å¾Œæœçš„è¡Œç‚ºï¼ŒæŸ¥çœ‹å°æ‡‰çš„æ³•å¾‹å¾Œæœèˆ‡æ¡ˆä¾‹ã€‚</p>
    <div class="checkbox-group" id="behavior-filters">
      <label><input type="checkbox" name="behavior" value="physical-injury" data-type="1" data-name="è‚¢é«”æ¨æ‰“ / é€ æˆè¼•å‚·"> è‚¢é«”æ¨æ‰“ / é€ æˆè¼•å‚·</label>
      <label><input type="checkbox" name="behavior" value="online-slander" data-type="2" data-name="ç¶²è·¯æ•£å¸ƒè¬ è¨€ / æå®³åè­½"> ç¶²è·¯æ•£å¸ƒè¬ è¨€ / æå®³åè­½</label>
      <label><input type="checkbox" name="behavior" value="money-extortion" data-type="3" data-name="å¨è„…å–è²¡ / ææ¯€æ”¯ä»˜é‡‘éŒ¢"> å¨è„…å–è²¡ / ææ¯€æ”¯ä»˜é‡‘éŒ¢</label>
      <label><input type="checkbox" name="behavior" value="psychological-damage" data-type="4" data-name="å¯†é›†è¨Šæ¯é¨·æ“¾ / é€ æˆç²¾ç¥å£“åŠ›"> å¯†é›†è¨Šæ¯é¨·æ“¾ / é€ æˆç²¾ç¥å£“åŠ›</label>
    </div>
  </div>

  <div class="results-panel">
    <h2>æ­¥é©ŸäºŒï¼šå¾Œæœè­¦ç¤º (å³æ™‚äº’å‹•)</h2>
    <p>è«‹åœ¨ä¸Šæ–¹å‹¾é¸è¡Œç‚ºæ¨™ç±¤ï¼Œçµæœå°‡å³æ™‚é¡¯ç¤ºç›¸é—œæ³•å¾‹æ¢æ–‡ã€‚</p>
    <div id="results-area">
      <p id="initial-loading-status" class="loading-message" style="text-align:center; font-size:1.1em;">è¼‰å…¥æ³•å¾‹è³‡æ–™ä¸­...</p>
    </div>
  </div>

  <div class="case-panel">
    <h2>æ­¥é©Ÿä¸‰ï¼šç›¸é—œæ¡ˆä¾‹</h2>
    <p>è«‹åœ¨ä¸Šæ–¹å‹¾é¸è¡Œç‚ºæ¨™ç±¤ï¼ŒæŸ¥çœ‹ç›¸é—œæ–°èæ¡ˆä¾‹ã€‚</p>
    <div id="case-area"></div>
  </div>
</div>

<!-- æŒ‰éˆ•å€å¡Š -->
<div class="button-footer">
  <a href="index.html" class="btn-animated btn-gray">
    <span class="default-text">â† è¿”å›é¦–é </span>
    <span class="hover-text">è¿”å›é¦–é </span>
  </a>

  <button id="next-btn" class="btn-animated btn-green">
    <span class="default-text">ä¸‹ä¸€æ­¥ï¼šå­¸ç¿’å–® â†’</span>
    <span class="hover-text">ä¸‹ä¸€æ­¥</span>
  </button>
</div>
</div>
</div>
</main>

<footer>
<p>BCTP (Bullying Consequence Transparency Platform)</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const STATUTES_URL = 'https://raw.githubusercontent.com/augustttatf/bctp/refs/heads/main/meowmeowmeow.json';
  const CASES_URL = 'https://raw.githubusercontent.com/augustttatf/bctp/refs/heads/main/newjeans.json';

  const mainContentWrapper = document.getElementById('main-content-wrapper');
  const initialLoadingStatus = document.getElementById('initial-loading-status');
  const filterContainer = document.getElementById('behavior-filters');
  const resultsArea = document.getElementById('results-area');
  const caseArea = document.getElementById('case-area');
  const checkboxes = filterContainer.querySelectorAll('input[type="checkbox"]');
  const nextBtn = document.getElementById('next-btn');

  const FATAL_ERROR_MESSAGE = 'ç¶²ç«™éŒ¯èª¤ï¼šæ ¸å¿ƒè³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå³å°‡è¿”å›é¦–é ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚';
  let lawData = { related_statutes_segmented: [], LawType_Mapping: {}, cases: [] };

  function getLawTypeLabel(law) {
    const lawTypeKey = law.LawType != null ? law.LawType.toString() : '';
    let lawTypeLabel = lawData.LawType_Mapping[lawTypeKey] || 'ç›¸é—œæ³•æ¢';
    if (law.LawType === 0) return `ğŸ›¡ï¸ ${lawTypeLabel}`;
    if (law.LawType === 5) return `ğŸ¤ ${lawTypeLabel}`;
    if (law.ReplenishType === 1) return `âš  ${lawTypeLabel} (å»ºè­°å’Œè§£/è³ å„Ÿ)`;
    return `ğŸ”— ${lawTypeLabel}`;
  }

  async function loadLawData() {
    try {
      const [statutesResponse, casesResponse] = await Promise.all([
        fetch(STATUTES_URL),
        fetch(CASES_URL)
      ]);

      if (!statutesResponse.ok) throw new Error(`æ³•æ¢æª”æ¡ˆè¼‰å…¥å¤±æ•— (HTTP ${statutesResponse.status})`);
      if (!casesResponse.ok) throw new Error(`æ¡ˆä¾‹æª”æ¡ˆè¼‰å…¥å¤±æ•— (HTTP ${casesResponse.status})`);

      const statutesData = await statutesResponse.json();
      const casesData = await casesResponse.json();

      lawData.related_statutes_segmented = statutesData.related_statutes_segmented || [];
      lawData.LawType_Mapping = statutesData.LawType_Mapping || {};
      lawData.cases = Array.isArray(casesData.news) ? casesData.news : [];

      if (initialLoadingStatus) initialLoadingStatus.remove();
      if (mainContentWrapper) mainContentWrapper.style.display = 'block';
      updateResults();
    } catch (error) {
      console.error('è¼‰å…¥æ³•å¾‹è³‡æ–™å¤±æ•—:', error);
      if (initialLoadingStatus) {
        initialLoadingStatus.innerHTML = `âŒ ${FATAL_ERROR_MESSAGE}<br>è©³ç´°éŒ¯èª¤: ${error.message}`;
        initialLoadingStatus.style.color = 'red';
      }
      alert(FATAL_ERROR_MESSAGE);
      window.location.href = 'index.html';
    }
  }

  // ä½ åŸæœ¬çš„ createLawCardï¼ˆä¿ç•™é‚è¼¯ï¼‰
  function createLawCard(lawGroup) {
    const card = document.createElement('div');

    const isSupplementCategory = lawGroup.isSupplementCategory;
    card.className = `law-card ${isSupplementCategory ? 'replenish-content' : ''}`;

    let html = `<h3 class="law-num-title">${lawGroup.LawNum || 'ç„¡æ¢æ¬¾è™Ÿ'}</h3>`;
    html += `<p class="law-details"><strong>æ¢æ–‡è©³æƒ…ï¼š</strong> ${lawGroup.LawDetails || 'ç„¡è©³æƒ…'}</p>`;

    if (Array.isArray(lawGroup.combinedNotes) && lawGroup.combinedNotes.length > 0) {
      html += '<ul class="combined-relevance-list">';
      const isGeneralOrSupplement = lawGroup.LawType === 0 || lawGroup.LawType === 5;

      lawGroup.combinedNotes.forEach(note => {
        if (isGeneralOrSupplement) {
          html += `<li><strong>${getLawTypeLabel(lawGroup)}ï¼š</strong> ${lawGroup.RelevanceNote || note.RelevanceNote || 'ç„¡ç›¸é—œæ€§èªªæ˜'}</li>`;
        } else {
          const specificLawTypeLabel = getLawTypeLabel(note);
          html += `<li><strong>${specificLawTypeLabel}ï¼š</strong> ${note.RelevanceNote || 'ç„¡ç›¸é—œæ€§èªªæ˜'}</li>`;
        }
      });

      html += '</ul>';
    }

    card.innerHTML = html;
    return card;
  }

  function createCaseCard(caseItem) {
    const card = document.createElement('div');
    card.className = 'case-card';
    let html = `<h4 class="case-title">${caseItem.newsTitle || 'ç„¡æ¡ˆä¾‹æ¨™é¡Œ'}</h4>`;
    html += `<p class="case-content"><strong>äº‹ä»¶ç¶“éï¼š</strong> ${caseItem.newscontent || 'ç„¡äº‹ä»¶ç¶“é'}</p>`;
    if (caseItem.source) html += `<p class="case-source"><strong>æ–°èä¾†æºï¼š</strong> <a href="${caseItem.source}" target="_blank">é»æ“ŠæŸ¥çœ‹</a></p>`;

    if (caseItem.videoconnection) {
      const youtubeMatch = caseItem.videoconnection.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|\w+\?v=)|youtu\.be\/)([\w-]+)/);
      const vimeoMatch = caseItem.videoconnection.match(/(?:vimeo\.com\/)(\d+)/);
      if (youtubeMatch && youtubeMatch[1]) {
        html += `<div class="video-container"><iframe src="https://www.youtube.com/embed/${youtubeMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
      } else if (vimeoMatch && vimeoMatch[1]) {
        html += `<div class="video-container"><iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
      } else {
        html += `<p class="case-video"><strong>ç›¸é—œå½±ç‰‡ï¼š</strong> <a href="${caseItem.videoconnection}" target="_blank">é»æ“ŠæŸ¥çœ‹å½±ç‰‡</a></p>`;
      }
    }

    card.innerHTML = html;
    return card;
  }

  function updateResults() {
    resultsArea.innerHTML = '';
    caseArea.innerHTML = '';

    const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);

    // ç„¡å‹¾é¸ï¼šæ¸…ç©º localStorage çš„é¸æ“‡ï¼Œé¡¯ç¤ºæç¤º
    if (checkedBoxes.length === 0) {
      localStorage.removeItem('selectedBehaviors');
      localStorage.removeItem('selectedQuestionTypes');
      localStorage.removeItem('selectedBehaviorNames');
      resultsArea.innerHTML = '<p class="note">è«‹å‹¾é¸å·¦å´è¡Œç‚ºä»¥æŸ¥çœ‹å°æ‡‰æ³•å¾‹å¾Œæœã€‚</p>';
      caseArea.innerHTML = '';
      return;
    }

    const selectedLawTypes = new Set();
    const checkedBehaviorNames = [];
    const selectedBehaviorValues = [];
    const selectedQuestionTypes = [];

    checkedBoxes.forEach(cb => {
      const type = parseInt(cb.getAttribute('data-type'));
      selectedLawTypes.add(type);
      checkedBehaviorNames.push(`* ${cb.getAttribute('data-name')}`);
      selectedBehaviorValues.push(cb.value);
      selectedQuestionTypes.push(type);
    });

    // å„²å­˜åˆ° localStorageï¼ˆå¤šç¨®æ ¼å¼ï¼Œä¾› quiz.js å„ç¨®å¯¦ä½œè®€å–ï¼‰
    localStorage.setItem('selectedBehaviors', JSON.stringify(selectedBehaviorValues)); // ["physical-injury","online-slander"]
    localStorage.setItem('selectedQuestionTypes', JSON.stringify(selectedQuestionTypes)); // [1,2]
    localStorage.setItem('selectedBehaviorNames', checkedBehaviorNames.join('\n'));

    // ç¯©é¸ä¸¦åˆ†çµ„æ³•æ¢ï¼ˆå»é‡ï¼‰
    const groupedLaws = {};
    (lawData.related_statutes_segmented || []).forEach(law => {
      const isBehaviorLaw = law.LawType >= 1 && law.LawType <= 4;
      const isGeneralOrSupplementLaw = law.LawType === 0 || law.LawType === 5;
      if ((isBehaviorLaw && selectedLawTypes.has(law.LawType)) || isGeneralOrSupplementLaw) {
        const key = law.LawNum || (`no-num-${law.LawType}-${Math.random()}`);
        if (!groupedLaws[key]) {
          groupedLaws[key] = {
            LawNum: law.LawNum,
            LawDetails: law.LawDetails,
            LawType: law.LawType,
            RelevanceNote: law.RelevanceNote,
            isSupplementCategory: law.LawType === 5 || law.ReplenishType === 1,
            combinedNotes: []
          };
        }
        const alreadyExists = groupedLaws[key].combinedNotes.some(n => n.LawType === law.LawType);
        if (!alreadyExists) {
          groupedLaws[key].combinedNotes.push({
            LawType: law.LawType,
            ReplenishType: law.ReplenishType,
            RelevanceNote: law.RelevanceNote
          });
        }
        if (law.LawType === 5 || law.ReplenishType === 1) groupedLaws[key].isSupplementCategory = true;
      }
    });

    const uniqueLawArray = Object.values(groupedLaws);
    const coreLaws = uniqueLawArray.filter(l => !l.isSupplementCategory);
    const supplementLaws = uniqueLawArray.filter(l => l.isSupplementCategory);

    if (coreLaws.length > 0) {
      const title = document.createElement('h3');
      title.textContent = 'ğŸ›¡ï¸ æ ¸å¿ƒèˆ‡ç‰¹å®šè¡Œç‚ºç›¸é—œæ³•æ¢ï¼š';
      resultsArea.appendChild(title);
      coreLaws.forEach(lawGroup => resultsArea.appendChild(createLawCard(lawGroup)));
    } else {
      resultsArea.innerHTML += '<p class="note">ç„¡ç‰¹å®šè¡Œç‚ºçš„æ ¸å¿ƒæ³•æ¢ã€‚</p>';
    }

    if (supplementLaws.length > 0) {
      const title = document.createElement('h3');
      title.textContent = 'âš–ï¸ å”å•†ã€è³ å„Ÿèˆ‡æƒ…ç¯€è¼•å¾®è™•åˆ†ï¼š';
      resultsArea.appendChild(title);
      supplementLaws.forEach(lawGroup => resultsArea.appendChild(createLawCard(lawGroup)));
    }

    // é¡¯ç¤ºç›¸é—œæ¡ˆä¾‹
    const casesToDisplay = (lawData.cases || []).filter(c => {
      if (c && c.newsType != null) {
        const type = parseInt(c.newsType);
        return selectedLawTypes.has(type);
      }
      return false;
    });

    if (casesToDisplay.length === 0) {
      caseArea.innerHTML = '<p class="note">ç›®å‰æ²’æœ‰èˆ‡æ‰€é¸è¡Œç‚ºç›¸é—œçš„å…¬é–‹æ¡ˆä¾‹ã€‚</p>';
    } else {
      casesToDisplay.forEach(c => caseArea.appendChild(createCaseCard(c)));
    }
  }

  // ç¶å®š checkbox äº‹ä»¶
  checkboxes.forEach(cb => cb.addEventListener('change', updateResults));

  // ä¸‹ä¸€æ­¥æŒ‰éˆ•ï¼ˆæœƒä»¥ selectedQuestionTypes ä»¥åŠ selectedBehaviors ä¸€ä½µå­˜åœ¨ localStorageï¼‰
  nextBtn.addEventListener('click', function() {
    const selected = Array.from(checkboxes).filter(cb => cb.checked);
    if (selected.length === 0) {
      alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹è¡Œç‚ºï¼Œæ‰èƒ½é€²å…¥å­¸ç¿’å–®ï¼');
      return;
    }
    // ï¼ˆupdateResults å·²å°‡è³‡æ–™å­˜åœ¨ localStorageï¼‰ç›´æ¥è·³è½‰
    window.location.href = 'quiz.html';
  });

  // å•Ÿå‹•
  loadLawData();
});
</script>
</body>
</html>

