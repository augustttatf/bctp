<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BCTP - è¡Œç‚ºå¾ŒæœæŸ¥è©¢</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">
</head>

<body>
<header>
  <div class="container">
    <h1>BCTP</h1>
    <p>éœ¸å‡Œè¡Œç‚ºå¾Œæœé€æ˜åŒ–è³‡è¨Šå¹³å°</p>
  </div>
</header>

<main>
  <div class="container">
    <div id="main-content-wrapper" style="display:none;">
      <div class="main-layout-grid">

        <!-- å·¦å´å‹¾é¸ -->
        <div class="filter-panel">
          <h2>æ­¥é©Ÿä¸€ï¼šè¡Œç‚ºå‹¾é¸</h2>
          <p>å‹¾é¸è§¸ç™¼æ³•å¾‹å¾Œæœçš„è¡Œç‚ºã€‚</p>

          <div class="checkbox-group" id="behavior-filters">
            <label><input type="checkbox" name="behavior" value="è‚¢é«”æ¨æ‰“" data-type="2"> è‚¢é«”æ¨æ‰“</label>
            <label><input type="checkbox" name="behavior" value="ç¶²è·¯æ•£å¸ƒè¬ è¨€" data-type="3"> ç¶²è·¯æ•£å¸ƒè¬ è¨€</label>
            <label><input type="checkbox" name="behavior" value="å¨è„…å–è²¡" data-type="4"> å¨è„…å–è²¡</label>
            <label><input type="checkbox" name="behavior" value="å¯†é›†è¨Šæ¯é¨·æ“¾" data-type="5"> å¯†é›†è¨Šæ¯é¨·æ“¾</label>
            <label><input type="checkbox" name="behavior" value="æ€§éœ¸å‡Œ" data-type="6"> æ€§éœ¸å‡Œ</label>
          </div>
        </div>

        <!-- æ³•æ¢å€ -->
        <div class="results-panel">
          <h2>æ­¥é©ŸäºŒï¼šå¾Œæœè­¦ç¤º</h2>
          <p>å‹¾é¸è¡Œç‚ºå¾Œï¼Œè‡ªå‹•é¡¯ç¤ºç›¸é—œæ³•å¾‹å¾Œæœã€‚</p>

          <div id="results-area">
            <p id="initial-loading-status" class="loading-message" style="text-align:center;">è¼‰å…¥æ³•å¾‹è³‡æ–™ä¸­...</p>
          </div>
        </div>

        <!-- æ¡ˆä¾‹å€ -->
        <div class="case-panel">
          <h2>æ­¥é©Ÿä¸‰ï¼šç›¸é—œæ¡ˆä¾‹</h2>
          <p>å‹¾é¸è¡Œç‚ºå¾ŒæŸ¥çœ‹å¯¦éš›æ¡ˆä¾‹ã€‚</p>
          <div id="case-area"></div>
        </div>

      </div>

      <!-- åº•éƒ¨æŒ‰éˆ• -->
      <div class="button-footer">

        <button class="btn-animated btn-gray" onclick="location.href='index.html'">
          <span class="default-text">â† è¿”å›é¦–é </span>
          <span class="hover-text">è¿”å›é¦–é </span>
        </button>

        <button id="next-btn" class="btn-animated btn-green">
          <span class="default-text">ä¸‹ä¸€æ­¥ï¼šæ¸¬é©— â†’</span>
          <span class="hover-text">éœ¸å‡Œè¡Œç‚ºæ¸¬é©—</span>
        </button>

      </div>
    </div>
  </div>
</main>

<footer>
  <p>BCTP (Bullying Consequence Transparency Platform)</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const STATUTES_URL = 'https://raw.githubusercontent.com/augustttatf/bctp/main/meowmeowmeow.json';
  const CASES_URL = 'https://raw.githubusercontent.com/augustttatf/bctp/main/newjeans.json';

  const mainContentWrapper = document.getElementById('main-content-wrapper');
  const initialLoadingStatus = document.getElementById('initial-loading-status');
  const filterContainer = document.getElementById('behavior-filters');
  const resultsArea = document.getElementById('results-area');
  const caseArea = document.getElementById('case-area');
  const checkboxes = filterContainer.querySelectorAll('input[type="checkbox"]');
  const nextBtn = document.getElementById('next-btn');

  let lawData = { related_statutes_segmented: [], LawType_Mapping: {}, cases: [] };

  /* -----------------------------------------------
     è¼‰å…¥è³‡æ–™
  ------------------------------------------------- */
  async function loadLawData() {
    try {
      const [statutesResp, casesResp] = await Promise.all([
        fetch(STATUTES_URL),
        fetch(CASES_URL)
      ]);

      const statutesJson = await statutesResp.json();
      const casesJson = await casesResp.json();

      lawData.related_statutes_segmented = statutesJson.related_statutes_segmented || [];
      lawData.LawType_Mapping = statutesJson.LawType_Mapping || {};
      lawData.cases = Array.isArray(casesJson.news) ? casesJson.news : [];

      initialLoadingStatus.remove();
      mainContentWrapper.style.display = 'block';

      updateResults();

    } catch (e) {
      alert('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå°‡è¿”å›é¦–é ã€‚');
      window.location.href = 'index.html';
    }
  }

  /* -----------------------------------------------
     ç”¢ç”Ÿé¡¯ç¤ºæ¨™ç±¤ï¼ˆå·²ä¿®æ­£ï¼‰
  ------------------------------------------------- */
  function getLawTypeLabel(law) {

    // â­ ReplenishType=1 â†’ å¼·åˆ¶é¡¯ç¤ºæ³•æ¢è£œå……ï¼ˆ1ï¼‰
    if (law.ReplenishType === 1) {
      return `âš  ${lawData.LawType_Mapping["1"]} (å»ºè­°å’Œè§£/è³ å„Ÿ)`;
    }

    const key = String(law.LawType ?? '');
    const label = lawData.LawType_Mapping[key] || 'ç›¸é—œæ³•æ¢';

    if (law.LawType === 0) return `ğŸ›¡ï¸ ${label}`; // é€šç”¨
    if (law.LawType === 1) return `ğŸ¤ ${label}`; // æ³•æ¢è£œå……
    return `ğŸ”— ${label}`; // 2~6
  }

  /* -----------------------------------------------
     æ³•æ¢å¡ç‰‡
  ------------------------------------------------- */
  function createLawCard(group) {
    const div = document.createElement('div');
    div.className = `law-card ${group.isSupplementCategory ? 'replenish-content' : ''}`;

    let html = `
      <h3 class="law-num-title">${group.LawNum}</h3>
      <p class="law-details"><strong>æ¢æ–‡è©³æƒ…ï¼š</strong> ${group.LawDetails}</p>
      <ul class="combined-relevance-list">
    `;

    group.combinedNotes.forEach(note => {
      html += `<li><strong>${getLawTypeLabel(note)}ï¼š</strong> ${note.RelevanceNote}</li>`;
    });

    html += `</ul>`;
    div.innerHTML = html;
    return div;
  }

  /* -----------------------------------------------
     æ¡ˆä¾‹å¡ç‰‡
  ------------------------------------------------- */
  function createCaseCard(item) {
    const div = document.createElement('div');
    div.className = 'case-card';

    let html = `
      <h4 class="case-title">${item.newsTitle || 'ç„¡æ¡ˆä¾‹æ¨™é¡Œ'}</h4>
      <p class="case-content"><strong>äº‹ä»¶ç¶“éï¼š</strong> ${item.newscontent || 'ç„¡å…§å®¹'}</p>
    `;

    if (item.source) {
      html += `<p class="case-source"><strong>ä¾†æºï¼š</strong> 
                <a href="${item.source}" target="_blank">é»æ“ŠæŸ¥çœ‹</a></p>`;
    }

    if (item.videoconnection) {
      const yt = item.videoconnection.match(/(?:youtu\.be\/|v=)([\w-]+)/);
      if (yt) {
        html += `<div class="video-container"><iframe src="https://www.youtube.com/embed/${yt[1]}" frameborder="0" allowfullscreen></iframe></div>`;
      }
    }

    div.innerHTML = html;
    return div;
  }

  /* -----------------------------------------------
     æ›´æ–°é¡¯ç¤ºçµæœï¼ˆæ ¸å¿ƒï¼‰
  ------------------------------------------------- */
  function updateResults() {

    resultsArea.innerHTML = '';
    caseArea.innerHTML = '';

    const checked = [...checkboxes].filter(cb => cb.checked);

    if (checked.length === 0) {
      resultsArea.innerHTML = `<p class="note">è«‹å‹¾é¸å·¦å´è¡Œç‚ºä»¥æŸ¥çœ‹æ³•å¾‹å¾Œæœã€‚</p>`;
      return;
    }

    const selectedTypes = checked.map(cb => Number(cb.dataset.type));
    localStorage.setItem('selectedQuestionTypes', JSON.stringify(selectedTypes));

    /* ------ æ³•æ¢ç¯©é¸ ------ */
    const grouped = {};

    lawData.related_statutes_segmented.forEach(law => {

      const shouldShow =
        selectedTypes.includes(law.LawType) ||
        law.LawType === 0 ||                 // é€šç”¨
        law.ReplenishType === 1;             // è£œå……æ³•æ¢æ°¸é é¡¯ç¤º

      if (!shouldShow) return;

      const key = law.LawNum;

      if (!grouped[key]) {
        grouped[key] = {
          LawNum: law.LawNum,
          LawDetails: law.LawDetails,
          isSupplementCategory: (law.ReplenishType === 1),
          combinedNotes: []
        };
      }

      grouped[key].combinedNotes.push({
        LawType: law.LawType,
        RelevanceNote: law.RelevanceNote,
        ReplenishType: law.ReplenishType
      });
    });

    Object.values(grouped).forEach(g => {
      resultsArea.appendChild(createLawCard(g));
    });

    /* ------ æ¡ˆä¾‹ç¯©é¸ ------ */
    const caseList = lawData.cases.filter(c =>
      selectedTypes.includes(Number(c.newsType))
    );

    if (caseList.length === 0) {
      caseArea.innerHTML = `<p class="note">ç›®å‰æ²’æœ‰ç›¸é—œæ¡ˆä¾‹ã€‚</p>`;
    } else {
      caseList.forEach(c => caseArea.appendChild(createCaseCard(c)));
    }
  }

  /* -----------------------------------------------
     äº‹ä»¶ç¶å®š
  ------------------------------------------------- */
  checkboxes.forEach(cb => cb.addEventListener('change', updateResults));

  nextBtn.addEventListener('click', () => {
    if (![...checkboxes].some(cb => cb.checked)) {
      alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹è¡Œç‚ºï¼');
      return;
    }
    window.location.href = 'quiz.html';
  });

  loadLawData();

});
</script>

</body>
</html>
