<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCTP - è¡Œç‚ºå¾ŒæœæŸ¥è©¢</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">
</head>
<body>
    <header>
        <div class="container">
            <h1>BCTP</h1>
            <p>éœ¸å‡Œè¡Œç‚ºå¾Œæœé€æ˜åŒ–è³‡è¨Šå¹³å°</p>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="main-layout">
                
                <div class="filter-panel">
                    <h2>æ­¥é©Ÿä¸€ï¼šè¡Œç‚ºå‹¾é¸ vc</h2>
                    <p>å‹¾é¸è§¸ç™¼æ³•å¾‹å¾Œæœçš„è¡Œç‚ºï¼ŒæŸ¥çœ‹å°æ‡‰çš„æ³•å¾‹å¾Œæœã€‚</p>

                    <div class="checkbox-group" id="behavior-filters">
                        <label><input type="checkbox" name="behavior" value="physical-injury" data-type="1" data-name="è‚¢é«”æ¨æ‰“ / é€ æˆè¼•å‚·"> è‚¢é«”æ¨æ‰“ / é€ æˆè¼•å‚·</label>
                        <label><input type="checkbox" name="behavior" value="online-slander" data-type="2" data-name="ç¶²è·¯æ•£å¸ƒè¬ è¨€ / æå®³åè­½"> ç¶²è·¯æ•£å¸ƒè¬ è¨€ / æå®³åè­½</label>
                        <label><input type="checkbox" name="behavior" value="money-extortion" data-type="3" data-name="å¨è„…å–è²¡ / ææ¯€æ”¯ä»˜é‡‘éŒ¢"> å¨è„…å–è²¡ / ææ¯€æ”¯ä»˜é‡‘éŒ¢</label>
                        <label><input type="checkbox" name="behavior" value="psychological-damage" data-type="4" data-name="å¯†é›†è¨Šæ¯é¨·æ“¾ / é€ æˆç²¾ç¥å£“åŠ›"> å¯†é›†è¨Šæ¯é¨·æ“¾ / é€ æˆç²¾ç¥å£“åŠ›</label>
                    </div>
                </div>

                <div class="results-panel">
                    <h2>æ­¥é©ŸäºŒï¼šå¾Œæœè­¦ç¤º (å³æ™‚äº’å‹•)</h2>
                    <p>è«‹åœ¨å·¦å´å‹¾é¸è¡Œç‚ºæ¨™ç±¤ï¼Œçµæœå°‡å³æ™‚é¡¯ç¤ºç›¸é—œæ³•å¾‹æ¢æ–‡èˆ‡åˆ¤ä¾‹ã€‚</p>

                    <div id="results-area">
                        <p id="loading-message">è¼‰å…¥æ³•å¾‹è³‡æ–™ä¸­...</p>
                    </div>
                </div>
                
            </div> 

            <div class="button-footer">
                <a href="form.html" id="next-form-button" class="submit-button">ä¸‹ä¸€æ­¥ï¼šåæ€è¡¨å–® &rarr;</a>
            </div>
        </div>
    </main>
    
    <footer>
        <p>BCTP (Bullying Consequence Transparency Platform)</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è«‹ç¢ºä¿æ‚¨çš„ JSON æª”æ¡ˆç¶²å€æ˜¯æ­£ç¢ºçš„ï¼
            const JSON_URL = 'https://raw.githubusercontent.com/voidSTU/BCTP/refs/heads/main/meowmeowmeow.json'; 
            
            const filterContainer = document.getElementById('behavior-filters');
            const resultsArea = document.getElementById('results-area');
            const loadingMessage = document.getElementById('loading-message');
            const checkboxes = filterContainer.querySelectorAll('input[type="checkbox"]');
            
            let lawData = { related_statutes_segmented: [], LawType_Mapping: {} }; 
            let generalLaws = []; // LawType: 0 (é€šç”¨/ä¿è­·è™•åˆ†)
            let minorOffenseLaws = []; // LawType: 5 (æƒ…ç¯€è¼•å¾®/ä¸ä»˜å¯©ç†)

            localStorage.removeItem('selectedBehaviors');

            async function loadLawData() {
                try {
                    const response = await fetch(JSON_URL); 
                    if (!response.ok) {
                        throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                    }
                    const fullData = await response.json();
                    lawData = fullData;
                    
                    // ğŸš¨ é‚è¼¯æ›´æ–°ï¼šåˆ†é–‹å„²å­˜ LawType: 0 å’Œ LawType: 5
                    generalLaws = lawData.related_statutes_segmented.filter(law => law.LawType === 0);
                    minorOffenseLaws = lawData.related_statutes_segmented.filter(law => law.LawType === 5);
                    
                    loadingMessage.textContent = 'è¼‰å…¥å®Œæˆï¼Œè«‹å‹¾é¸å·¦å´è¡Œç‚ºã€‚';
                    loadingMessage.style.color = '#28a745';
                    updateResults(); 

                } catch (error) {
                    console.error('è¼‰å…¥æ³•å¾‹è³‡æ–™å¤±æ•—:', error);
                    loadingMessage.textContent = 'âŒ è¼‰å…¥æ³•å¾‹è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ JSON ç¶²å€æˆ–æ ¼å¼ã€‚';
                    loadingMessage.style.color = 'red';
                }
            }


            function createLawCard(law) {
                const card = document.createElement('div');
                // æ ¹æ“š ReplenishType çµ¦äºˆä¸åŒçš„é¡åˆ¥
                card.className = `law-card 
                    ${law.ReplenishType === 1 ? 'replenish-required' : ''} 
                    ${law.ReplenishType === 2 ? 'replenish-content' : ''}
                `; 
                
                let lawTypeLabel = lawData.LawType_Mapping[law.LawType.toString()] || 'ç›¸é—œæ³•æ¢';
                
                // æ¨™è¨˜ LawType: 0, 1, 5 çš„é¡¯ç¤ºåç¨±
                if (law.LawType === 0) {
                    lawTypeLabel = `ğŸ›¡ï¸ ${lawTypeLabel}`; // é€šç”¨æ³•æ¢
                } else if (law.LawType === 5) {
                    lawTypeLabel = `ğŸ¤ ${lawTypeLabel}`; // æƒ…ç¯€è¼•å¾®/ä¸ä»˜å¯©ç†è™•åˆ†
                } else if (law.ReplenishType === 1) {
                    lawTypeLabel = `âš  ${lawTypeLabel} (éœ€é…åˆè£œå……é …)`; // ç‰¹å®šè¡Œç‚ºä¸­ï¼Œéœ€è¦è£œå……çš„æ³•æ¢
                }

                let html = `<h3>${lawTypeLabel} - ${law.LawNum || 'ç„¡æ¢æ¬¾è™Ÿ'}</h3>`;
                html += `<p><strong>æ¢æ–‡è©³æƒ…ï¼š</strong> ${law.LawDetails || 'ç„¡è©³æƒ…'}</p>`;
                html += `<p class="note"><strong>(ç›¸é—œèªªæ˜)</strong> ${law.RelevanceNote || 'ç„¡ç›¸é—œæ€§èªªæ˜'}</p>`;
                
                card.innerHTML = html;
                return card;
            }


            function updateResults() {
                resultsArea.innerHTML = ''; 
                const selectedLawTypes = new Set(); 
                let checkedBehaviorNames = []; 
                let foundLaws = []; 
                let displayedLawIdentifiers = new Set(); 

                const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
                
                if (checkedBoxes.length === 0) {
                    resultsArea.appendChild(loadingMessage);
                    loadingMessage.textContent = 'è«‹å‹¾é¸å·¦å´è¡Œç‚ºä»¥æŸ¥çœ‹å°æ‡‰æ³•å¾‹å¾Œæœã€‚';
                    localStorage.removeItem('selectedBehaviors'); 
                    return;
                }
                
                checkedBoxes.forEach(cb => {
                    const type = parseInt(cb.getAttribute('data-type'));
                    selectedLawTypes.add(type);
                    checkedBehaviorNames.push(`* ${cb.getAttribute('data-name')}`); 
                });
                
                const selectedBehaviors = checkedBehaviorNames.join('\n'); 
                localStorage.setItem('selectedBehaviors', selectedBehaviors);

                if (loadingMessage) loadingMessage.remove(); 
                
                // 1. æ‰¾å‡ºæ‰€æœ‰é¸å®š LawType (1-4) çš„æ³•æ¢
                lawData.related_statutes_segmented.forEach(law => {
                    // åªæª¢æŸ¥ LawType 1-4
                    if (selectedLawTypes.has(law.LawType) && law.LawType >= 1 && law.LawType <= 4) {
                        const lawIdentifier = `${law.LawType}-${law.LawNum}`;
                        if (!displayedLawIdentifiers.has(lawIdentifier)) {
                            foundLaws.push(law);
                            displayedLawIdentifiers.add(lawIdentifier);
                        }
                    }
                });
                
                // 2. æ‰¾å‡ºæ‰€æœ‰ LawType: 0 çš„é€šç”¨æ³•æ¢ (å¿…é ˆé¡¯ç¤º)
                generalLaws.forEach(law => {
                    const lawIdentifier = `${law.LawType}-${law.LawNum}`;
                    if (!displayedLawIdentifiers.has(lawIdentifier)) {
                        foundLaws.push(law);
                        displayedLawIdentifiers.add(lawIdentifier);
                    }
                });
                
                // 3. æ‰¾å‡º LawType: 5 çš„æƒ…ç¯€è¼•å¾®/ä¸ä»˜å¯©ç†è™•åˆ† (å¿…é ˆé¡¯ç¤º)
                minorOffenseLaws.forEach(law => {
                    const lawIdentifier = `${law.LawType}-${law.LawNum}`;
                    if (!displayedLawIdentifiers.has(lawIdentifier)) {
                        foundLaws.push(law);
                        displayedLawIdentifiers.add(lawIdentifier);
                    }
                });


                if (foundLaws.length === 0) {
                     resultsArea.innerHTML = `<p style="color: red;">æŠ±æ­‰ï¼Œç›®å‰è³‡æ–™åº«ä¸­æœªæ‰¾åˆ°èˆ‡æ‚¨å‹¾é¸è¡Œç‚ºç›¸é—œçš„æ³•å¾‹æ¢æ–‡ã€‚</p>`;
                     return;
                }
                
                // 4. å€åˆ†ä¸¦é¡¯ç¤ºçµæœ
                let neededReplenishLaws = foundLaws.filter(law => law.ReplenishType === 1);
                // ğŸš¨ é‚è¼¯æ›´æ–°ï¼šå°‡ LawType: 5 çš„ ReplenishType: 2 å–®ç¨åˆ†é›¢å‡ºä¾†
                let replenishContents = foundLaws.filter(law => law.ReplenishType === 2 || law.LawType === 5);
                let otherLaws = foundLaws.filter(law => law.ReplenishType === 0 && law.LawType !== 5); // æ’é™¤ LawType 5

                // --- é¡¯ç¤ºæ ¸å¿ƒæ³•æ¢ (ç‰¹å®šè¡Œç‚ºèˆ‡é€šç”¨ä¿è­·è™•åˆ†) ---
                const mainTitle = document.createElement('h3');
                mainTitle.textContent = "ğŸ›¡ï¸ æ ¸å¿ƒèˆ‡ç‰¹å®šè¡Œç‚ºç›¸é—œæ³•æ¢ (ReplenishType: 0)ï¼š";
                resultsArea.appendChild(mainTitle);
                if (otherLaws.length === 0) {
                    resultsArea.innerHTML += '<p class="note">ç„¡ç‰¹å®šè¡Œç‚ºçš„æ ¸å¿ƒæ³•æ¢ã€‚</p>';
                } else {
                    otherLaws.forEach(law => resultsArea.appendChild(createLawCard(law)));
                }


                // --- é¡¯ç¤ºéœ€è¦è£œå……çš„æ³•æ¢ (ReplenishType: 1) ---
                if (neededReplenishLaws.length > 0) {
                    const requiredDiv = document.createElement('div');
                    requiredDiv.className = 'replenish-section';
                    requiredDiv.innerHTML = '<h4>ğŸ‘‰ éœ€é…åˆè£œå……é …çš„æ¢æ–‡ (å¦‚å’Œè§£/è³ å„Ÿ)ï¼š</h4>';
                    neededReplenishLaws.forEach(law => requiredDiv.appendChild(createLawCard(law)));
                    resultsArea.appendChild(requiredDiv);
                }

                // --- é¡¯ç¤ºè£œå……é …çš„å…§å®¹ (ReplenishType: 2 æˆ– LawType: 5) ---
                if (replenishContents.length > 0) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'replenish-section';
                    contentDiv.innerHTML = '<h4>ğŸ¤ è£œå……é … (æƒ…ç¯€è¼•å¾®è™•åˆ†ç´°ç¯€/å’Œè§£è™•åˆ†ç´°ç¯€)ï¼š</h4>';
                    replenishContents.forEach(law => contentDiv.appendChild(createLawCard(law)));
                    resultsArea.appendChild(contentDiv);
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateResults);
            });
            
            loadLawData();
        });
    </script>
</body>
</html>
