<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCTP - è¡Œç‚ºå¾ŒæœæŸ¥è©¢</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">
</head>
<body>
    <header>
        <div class="container">
            <h1>BCTP</h1>
            <p>éœ¸å‡Œè¡Œç‚ºå¾Œæœé€æ˜åŒ–è³‡è¨Šå¹³å°</p>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="main-layout">
                
                <div class="filter-panel">
                    <h2>æ­¥é©Ÿä¸€ï¼šè¡Œç‚ºå‹¾é¸</h2>
                    <p>å‹¾é¸è§¸ç™¼æ³•å¾‹å¾Œæœçš„è¡Œç‚ºï¼ŒæŸ¥çœ‹å°æ‡‰çš„æ³•å¾‹å¾Œæœã€‚</p>

                    <div class="checkbox-group" id="behavior-filters">
                        <label><input type="checkbox" name="behavior" value="physical-injury" data-type="1" data-name="è‚¢é«”æ¨æ‰“ / é€ æˆè¼•å‚·"> è‚¢é«”æ¨æ‰“ / é€ æˆè¼•å‚·</label>
                        <label><input type="checkbox" name="behavior" value="online-slander" data-type="2" data-name="ç¶²è·¯æ•£å¸ƒè¬ è¨€ / æå®³åè­½"> ç¶²è·¯æ•£å¸ƒè¬ è¨€ / æå®³åè­½</label>
                        <label><input type="checkbox" name="behavior" value="money-extortion" data-type="3" data-name="å¨è„…å–è²¡ / ææ¯€æ”¯ä»˜é‡‘éŒ¢"> å¨è„…å–è²¡ / ææ¯€æ”¯ä»˜é‡‘éŒ¢</label>
                        <label><input type="checkbox" name="psychological-damage" data-type="4" data-name="å¯†é›†è¨Šæ¯é¨·æ“¾ / é€ æˆç²¾ç¥å£“åŠ›"> å¯†é›†è¨Šæ¯é¨·æ“¾ / é€ æˆç²¾ç¥å£“åŠ›</label>
                    </div>
                </div>

                <div class="results-panel">
                    <h2>æ­¥é©ŸäºŒï¼šå¾Œæœè­¦ç¤º (å³æ™‚äº’å‹•)</h2>
                    <p>è«‹åœ¨å·¦å´å‹¾é¸è¡Œç‚ºæ¨™ç±¤ï¼Œçµæœå°‡å³æ™‚é¡¯ç¤ºç›¸é—œæ³•å¾‹æ¢æ–‡èˆ‡åˆ¤ä¾‹ã€‚</p>

                    <div id="results-area">
                        <p id="loading-message">è¼‰å…¥æ³•å¾‹è³‡æ–™ä¸­...</p>
                    </div>
                </div>
                
            </div> 

            <div class="button-footer">
                <a href="form.html" id="next-form-button" class="submit-button">ä¸‹ä¸€æ­¥ï¼šåæ€è¡¨å–® &rarr;</a>
            </div>
        </div>
    </main>
    
    <footer>
        <p>BCTP (Bullying Consequence Transparency Platform)</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // *** ğŸš¨ JSON ç¶²å€ (è«‹ç¢ºä¿æ­¤ç¶²å€ç‚ºæœ‰æ•ˆé€£çµ) ***
            // ç”±æ–¼ç”¨æˆ¶æä¾›çš„ JSON ç¶²å€å¯èƒ½å†æ¬¡å¤±æ•ˆï¼Œé€™è£¡ä½¿ç”¨å‰ä¸€å€‹æœ‰æ•ˆç¶²å€ï¼Œè«‹è‡ªè¡Œæ›¿æ›ç‚ºæœ€æ–°çš„æœ‰æ•ˆç¶²å€
            const JSON_URL = 'https://raw.githubusercontent.com/augustttatf/bctp/refs/heads/main/meowmeowmeow.json'; 
            
            const filterContainer = document.getElementById('behavior-filters');
            const resultsArea = document.getElementById('results-area');
            const loadingMessage = document.getElementById('loading-message');
            const checkboxes = filterContainer.querySelectorAll('input[type="checkbox"]');
            
            let lawData = { related_statutes_segmented: [], LawType_Mapping: {} }; 

            localStorage.removeItem('selectedBehaviors');

            // è¼”åŠ©å‡½æ•¸ï¼šå–å¾— LawType é¡¯ç¤ºåç¨±å’Œæ¨™ç±¤
            function getLawTypeLabel(law) {
                let lawTypeLabel = lawData.LawType_Mapping[law.LawType.toString()] || 'ç›¸é—œæ³•æ¢';
                
                if (law.LawType === 0) {
                    return `ğŸ›¡ï¸ ${lawTypeLabel}`; // é€šç”¨æ³•æ¢
                } else if (law.LawType === 5) {
                    return `ğŸ¤ ${lawTypeLabel}`; // æ³•æ¢è£œå……
                } else if (law.ReplenishType === 1) {
                    return `âš  ${lawTypeLabel} (éœ€å’Œè§£/è³ å„Ÿ)`; // ç‰¹å®šè¡Œç‚ºä¸­ï¼Œéœ€è¦è£œå……çš„æ³•æ¢
                }
                return lawTypeLabel;
            }

            async function loadLawData() {
                try {
                    const response = await fetch(JSON_URL); 
                    
                    if (!response.ok) {
                        const errorStatus = response.status;
                        let errorMessage = `è¼‰å…¥å¤±æ•—ï¼šHTTP ç‹€æ…‹ç¢¼ ${errorStatus}ã€‚`;
                        if (errorStatus === 404) {
                            errorMessage += 'éŒ¯èª¤ï¼šæª”æ¡ˆä¸å­˜åœ¨æˆ–ç¶²å€éŒ¯èª¤ã€‚';
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const textData = await response.text();
                    let fullData;
                    try {
                        fullData = JSON.parse(textData);
                    } catch (e) {
                        throw new Error("JSON èªæ³•éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹ã€‚");
                    }

                    lawData = fullData;
                    
                    loadingMessage.textContent = 'âœ”ï¸ æ³•å¾‹è³‡æ–™è¼‰å…¥æˆåŠŸã€‚è«‹å‹¾é¸å·¦å´è¡Œç‚ºã€‚';
                    loadingMessage.style.color = '#28a745';
                    updateResults(); 

                } catch (error) {
                    console.error('è¼‰å…¥æ³•å¾‹è³‡æ–™å¤±æ•—:', error);
                    loadingMessage.innerHTML = `âŒ è¼‰å…¥æ³•å¾‹è³‡æ–™å¤±æ•—ï¼š<br><strong>${error.message}</strong><br>è«‹æª¢æŸ¥ JSON ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚`;
                    loadingMessage.style.color = 'red';
                }
            }


            // è¼”åŠ©å‡½æ•¸ï¼šå‰µå»ºé¡¯ç¤ºç”¨çš„æ³•æ¢å¡ç‰‡ (è™•ç†å»é‡è¤‡å¾Œçš„è³‡æ–™çµæ§‹)
            function createLawCard(lawGroup) {
                const card = document.createElement('div');
                
                // æ±ºå®šå¡ç‰‡æ¨£å¼ï¼šå¦‚æœä»»ä½•ä¸€å€‹ç›¸é—œè¡Œç‚ºæ˜¯ ReplenishType: 1 æˆ– LawType: 5ï¼Œå‰‡ä½¿ç”¨è£œå……/å’Œè§£æ¨£å¼
                const isSupplementCategory = lawGroup.isSupplementCategory;
                card.className = `law-card ${isSupplementCategory ? 'replenish-content' : ''}`; 
                
                // 1. ä¸»è¦æ¨™é¡Œå’Œæ¢æ–‡å…§å®¹ (åªé¡¯ç¤ºä¸€æ¬¡)
                let mainTitle = isSupplementCategory ? 'âš–ï¸ å”å•†ã€è³ å„Ÿæˆ–æƒ…ç¯€è¼•å¾®è™•åˆ†' : 'ğŸ›¡ï¸ æ ¸å¿ƒæ³•æ¢';
                
                // é‡å° LawType 0 çš„é€šç”¨æ³•æ¢ï¼Œæˆ‘å€‘åœ¨æ¨™é¡Œä¸Šä¸é‡è¤‡ LawType 0 çš„é€šç”¨æ¨™ç±¤
                // å°æ–¼ LawType 5ï¼Œç”±æ–¼å®ƒæœ¬èº«å°±æ˜¯ LawType 5 æ¢æ–‡ï¼Œå®ƒæœƒåœ¨ combinedNotes ä¸­é¡¯ç¤ºä¸€æ¬¡ LawType 5 çš„å®Œæ•´æ¨™ç±¤
                if (lawGroup.LawType === 0) {
                    mainTitle = `ğŸ›¡ï¸ ${lawData.LawType_Mapping[lawGroup.LawType.toString()]}`;
                }

                let html = `<h3 class="law-num-title">${lawGroup.LawNum || 'ç„¡æ¢æ¬¾è™Ÿ'}</h3>`;
                html += `<p class="law-details"><strong>æ¢æ–‡è©³æƒ…ï¼š</strong> ${lawGroup.LawDetails || 'ç„¡è©³æƒ…'}</p>`;

                // 2. å½™æ•´ç›¸é—œè¡Œç‚ºå’Œå‚™è¨» (å»é‡è¤‡)
                if (lawGroup.combinedNotes.length > 0) {
                    html += '<ul class="combined-relevance-list">';
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ LawType 0 æˆ– LawType 5 çš„æ¢æ–‡
                    const isGeneralOrSupplement = lawGroup.LawType === 0 || lawGroup.LawType === 5;

                    lawGroup.combinedNotes.forEach(note => {
                        // LawType 0 (é€šç”¨) æˆ– LawType 5 (æ³•æ¢è£œå……) çš„æ¢æ–‡ï¼Œåªé¡¯ç¤ºä¸€å€‹ç°¡å–®æ¨™ç±¤ (å› ç‚ºå®ƒä¸é‡å°ç‰¹å®šè¡Œç‚º)
                        if (isGeneralOrSupplement) {
                            html += `<li><strong>${getLawTypeLabel(lawGroup)}ï¼š</strong> ${lawGroup.RelevanceNote || 'ç„¡ç›¸é—œæ€§èªªæ˜'}</li>`;
                        } else {
                            // LawType 1-4 çš„æ¢æ–‡ï¼Œé¡¯ç¤ºç‰¹å®šçš„è¡Œç‚ºæ¨™ç±¤å’Œå‚™è¨»
                            const specificLawTypeLabel = getLawTypeLabel(note);
                            html += `<li><strong>${specificLawTypeLabel}ï¼š</strong> ${note.RelevanceNote || 'ç„¡ç›¸é—œæ€§èªªæ˜'}</li>`;
                        }
                    });

                    // é‡å° LawType 0 å’Œ LawType 5ï¼Œç”±æ–¼å®ƒå€‘ä¸æ‡‰è©²è¢«é‡è¤‡åˆ—å‡ºï¼Œæˆ‘å€‘åªé¡¯ç¤ºä¸€æ¬¡ï¼Œç„¶å¾ŒçµæŸ
                    if (isGeneralOrSupplement) {
                         // å› ç‚º LawType 0 å’Œ 5 åœ¨ combinedNotes è£¡åªæœƒæœ‰ä¸€å€‹æ¢ç›®ï¼Œä¸”åªåˆ—ä¸€æ¬¡
                    } else {
                        html += '</ul>';
                    }
                }
                
                card.innerHTML = html;
                return card;
            }


            function updateResults() {
                resultsArea.innerHTML = ''; 
                const selectedLawTypes = new Set(); 
                let checkedBehaviorNames = []; 
                let groupedLaws = {}; // ç”¨ LawNum ä½œç‚º Key é€²è¡Œå»é‡è¤‡
                let uniqueLawArray = []; // æœ€çµ‚çš„ LawGroup é™£åˆ—
                
                const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
                
                if (checkedBoxes.length === 0) {
                    resultsArea.appendChild(loadingMessage);
                    loadingMessage.textContent = 'è«‹å‹¾é¸å·¦å´è¡Œç‚ºä»¥æŸ¥çœ‹å°æ‡‰æ³•å¾‹å¾Œæœã€‚';
                    localStorage.removeItem('selectedBehaviors'); 
                    return;
                }
                
                checkedBoxes.forEach(cb => {
                    const type = parseInt(cb.getAttribute('data-type'));
                    selectedLawTypes.add(type);
                    checkedBehaviorNames.push(`* ${cb.getAttribute('data-name')}`); 
                });
                
                const selectedBehaviors = checkedBehaviorNames.join('\n'); 
                localStorage.setItem('selectedBehaviors', selectedBehaviors);

                if (loadingMessage) loadingMessage.remove(); 
                
                // 1. ç¯©é¸ã€åˆ†çµ„ä¸¦å»é‡è¤‡æ³•æ¢
                lawData.related_statutes_segmented.forEach(law => {
                    const isBehaviorLaw = law.LawType >= 1 && law.LawType <= 4;
                    const isGeneralOrSupplementLaw = law.LawType === 0 || law.LawType === 5;
                    
                    // ç¢ºä¿åªè™•ç†é¸ä¸­çš„è¡Œç‚º LawType (1-4)ï¼Œæˆ–é€šç”¨çš„ LawType (0, 5)
                    if ( (isBehaviorLaw && selectedLawTypes.has(law.LawType)) || isGeneralOrSupplementLaw) {
                        
                        const key = law.LawNum;
                        
                        if (!groupedLaws[key]) {
                            // åˆå§‹åŒ–æ³•æ¢ç¾¤çµ„
                            groupedLaws[key] = {
                                LawNum: law.LawNum,
                                LawDetails: law.LawDetails,
                                LawType: law.LawType, // ä¿ç•™ LawType ç”¨æ–¼åˆ†é¡ LawType 0/5
                                RelevanceNote: law.RelevanceNote, // ä¿ç•™ LawType 0/5 çš„å‚™è¨»
                                isSupplementCategory: law.LawType === 5 || law.ReplenishType === 1,
                                combinedNotes: []
                            };
                        }
                        
                        // é‡å° LawType 1-4ï¼Œå°‡å…¶è¡Œç‚ºå‚™è¨»åŠ å…¥ combinedNotes
                        if (isBehaviorLaw) {
                            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡è¤‡åŠ å…¥ (é›–ç„¶ LawNum å·²ç¶“æ˜¯ Keyï¼Œä½†å¤šé‡è¡Œç‚ºæœƒå…±ç”¨ LawNum)
                            // é€™è£¡é€é LawType ä¾†ç¢ºèªæ˜¯å¦æ˜¯é‡è¤‡çš„è¡Œç‚º-æ³•æ¢çµ„åˆ
                            const alreadyExists = groupedLaws[key].combinedNotes.some(note => note.LawType === law.LawType);
                            
                            if (!alreadyExists) {
                                groupedLaws[key].combinedNotes.push({
                                    LawType: law.LawType,
                                    ReplenishType: law.ReplenishType,
                                    RelevanceNote: law.RelevanceNote
                                });
                            }
                        } else if (isGeneralOrSupplementLaw && groupedLaws[key].combinedNotes.length === 0) {
                             // LawType 0/5 åªéœ€è¦é¡¯ç¤ºä¸€æ¬¡ï¼Œå°‡å…¶è‡ªèº«ä½œç‚ºå”¯ä¸€è¨»é‡‹
                            groupedLaws[key].combinedNotes.push({
                                LawType: law.LawType,
                                ReplenishType: law.ReplenishType,
                                RelevanceNote: law.RelevanceNote
                            });
                        }

                        // å¦‚æœé€™å€‹ LawNum ä¾†æºæ–¼ä»»ä½• ReplenishType 1 æˆ– LawType 5ï¼Œå‰‡å°‡æ•´å€‹ç¾¤çµ„è¨­ç‚º Supplementary
                        if (law.LawType === 5 || law.ReplenishType === 1) {
                            groupedLaws[key].isSupplementCategory = true;
                        }
                    }
                });
                
                // 2. å°‡åˆ†çµ„çµæœè½‰æ›ç‚ºé™£åˆ—ï¼Œä¸¦æŒ‰åˆ†é¡åˆ†çµ„
                uniqueLawArray = Object.values(groupedLaws);
                
                let coreLaws = uniqueLawArray.filter(lawGroup => !lawGroup.isSupplementCategory);
                let supplementLaws = uniqueLawArray.filter(lawGroup => lawGroup.isSupplementCategory);


                // --- é¡¯ç¤ºæ ¸å¿ƒæ³•æ¢ (ç‰¹å®šè¡Œç‚º ReplenishType: 0 å’Œ LawType: 0) ---
                const mainTitle = document.createElement('h3');
                mainTitle.textContent = "ğŸ›¡ï¸ æ ¸å¿ƒèˆ‡ç‰¹å®šè¡Œç‚ºç›¸é—œæ³•æ¢ï¼š";
                resultsArea.appendChild(mainTitle);
                
                if (coreLaws.length === 0) {
                    resultsArea.innerHTML += '<p class="note">ç„¡ç‰¹å®šè¡Œç‚ºçš„æ ¸å¿ƒæ³•æ¢ã€‚</p>';
                } else {
                    coreLaws.forEach(lawGroup => resultsArea.appendChild(createLawCard(lawGroup)));
                }


                // --- é¡¯ç¤ºå”å•†èˆ‡è¼•å¾®è™•åˆ† (åˆä½µé¡¯ç¤º ReplenishType: 1 å’Œ LawType: 5/ReplenishType: 2) ---
                if (supplementLaws.length > 0) {
                    const combinedTitle = document.createElement('h3');
                    combinedTitle.textContent = "âš–ï¸ å”å•†ã€è³ å„Ÿèˆ‡æƒ…ç¯€è¼•å¾®è™•åˆ†ï¼š";
                    resultsArea.appendChild(combinedTitle);
                    
                    // é€™è£¡ä¸éœ€è¦å†ç´°åˆ†ï¼Œç›´æ¥å°‡æ‰€æœ‰ supplementLaws è¼¸å‡ºå³å¯
                    supplementLaws.forEach(lawGroup => resultsArea.appendChild(createLawCard(lawGroup)));
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateResults);
            });
            
            loadLawData();
        });
    </script>
</body>
</html>
