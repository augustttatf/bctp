<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BCTP - 霸凌行為測驗 beta</title>

<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  .container { max-width: 900px; margin:auto; padding:20px; }
  .quiz-question {
    background:#fff;
    border:1px solid #ccc;
    border-radius:6px;
    padding:15px;
    margin-bottom:20px;
  }
  .answer {
    color:#c00;
    font-size:0.9em;
  }
  #score-box {
    margin-top:20px;
    font-size:1.2em;
    font-weight:bold;
  }
</style>
</head>

<body>

<div class="container">
  <h1>BCTP 霸凌行為測驗beta</h1>

  <div id="quiz-container"></div>

  <button id="next-btn">提交測驗</button>

  <div id="score-box"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {

  const QUIZ_JSON_URL =
    'https://raw.githubusercontent.com/augustttatf/bctp/main/blablabla.json';

  const quizContainer = document.getElementById('quiz-container');
  const nextBtn = document.getElementById('next-btn');
  const scoreBox = document.getElementById('score-box');

  let quizQuestions = [];
  let score = 0;

  const selectedQuestionTypes =
    JSON.parse(localStorage.getItem('selectedQuestionTypes') || '[]');

  if (!selectedQuestionTypes.length) {
    alert('未選擇行為類型，返回上一頁');
    window.location.href = 'query.html';
    return;
  }

  const res = await fetch(QUIZ_JSON_URL);
  const data = await res.json();

  const groupedByType = {};
  selectedQuestionTypes.forEach(type => {
    groupedByType[type] =
      data.questions.filter(q => q.questionType === type);
  });

  const totalQuestions = 10;
  const baseCount = Math.floor(totalQuestions / selectedQuestionTypes.length);
  let remainder = totalQuestions % selectedQuestionTypes.length;

  quizQuestions = [];
  selectedQuestionTypes.forEach(type => {
    let arr = groupedByType[type].slice();
    arr.sort(() => 0.5 - Math.random());
    let count = baseCount + (remainder > 0 ? 1 : 0);
    remainder--;
    quizQuestions.push(...arr.slice(0, count));
  });

  if (quizQuestions.length < totalQuestions) {
    const pool = [];
    Object.values(groupedByType).forEach(a => pool.push(...a));
    pool.sort(() => 0.5 - Math.random());
    quizQuestions.push(...pool.slice(0, totalQuestions - quizQuestions.length));
  }

  quizQuestions.sort(() => 0.5 - Math.random());

  function renderQuiz() {
    quizContainer.innerHTML = '';
    quizQuestions.forEach((q, idx) => {
      const div = document.createElement('div');
      div.className = 'quiz-question';

      div.innerHTML = `
        <h3>
          ${idx + 1}. ${q.question}
          <span class="answer">, answer=${q.options[q.correctAnswerIndex]}</span>
        </h3>
      `;

      q.options.forEach((opt, i) => {
        div.innerHTML += `
          <label>
            <input type="radio" name="q${idx}" value="${i}">
            ${opt}
          </label><br>
        `;
      });

      quizContainer.appendChild(div);
    });
  }

  renderQuiz();

  nextBtn.addEventListener('click', function () {
    score = 0;

    const answers = quizQuestions.map((q, idx) => {
      const selected =
        quizContainer.querySelector(\`input[name="q\${idx}"]:checked\`);
      if (selected && Number(selected.value) === q.correctAnswerIndex) {
        score += 10;
      }
      return selected ? Number(selected.value) : null;
    });

    scoreBox.textContent = `你的分數：${score} 分`;

    localStorage.setItem('quizAnswers', JSON.stringify({
      score,
      questionTypes: selectedQuestionTypes,
      answers
    }));

    // ⭐ 不管幾分，一定換頁
    window.location.href = 'form.html';
  });

});
</script>

</body>
</html>
