<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BCTP - éœ¸å‡Œè¡Œç‚ºæ¸¬é©—</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>">
<style>
  .quiz-question { margin-bottom: 20px; }
  .quiz-question h3 { margin-bottom: 10px; }
  label { display: block; margin-bottom: 5px; cursor: pointer; }
  #score-box { font-weight: bold; margin-top: 20px; }
  .btn-animated { cursor: pointer; padding: 10px 20px; border: none; border-radius: 5px; }
  .btn-green { background-color: #28a745; color: #fff; }
  .btn-green:hover { background-color: #218838; }
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>BCTP - éœ¸å‡Œè¡Œç‚ºæ¸¬é©—</h1>
    <p>è«‹ä¾ç…§é¡Œç›®ä½œç­”ï¼Œé” 60 åˆ†ä»¥ä¸Šæ‰èƒ½é€²å…¥åæ€è¡¨å–®ã€‚</p>
  </div>
</header>

<main>
  <div class="container">
    <form id="quiz-form"></form>
    <button id="submit-btn" class="btn-animated btn-green">
    <span class="default-text">ä¸‹ä¸€æ­¥ï¼šåæ€è¡¨å–® â†’</span>
    <span class="hover-text">æäº¤å­¸ç¿’å–®</span>
    <div id="score-box"></div>
  </div>
</main>

<footer>
<p>BCTP (Bullying Consequence Transparency Platform)</p>
</footer>

<script>
const QUESTIONS_URL = "https://raw.githubusercontent.com/augustttatf/bctp/refs/heads/main/blablabla.json";

let allQuestions = [];
let quizQuestions = [];
let currentIndex = 0;
let score = 0;
const totalQuestions = 10;

// å¾ localStorage å–å¾—é¸æ“‡çš„è¡Œç‚ºé¡å‹
const selectedTypes = JSON.parse(localStorage.getItem("selectedQuestionTypes") || "[]");

async function loadQuestions() {
  try {
    const res = await fetch(QUESTIONS_URL);
    const data = await res.json();
    allQuestions = data.questions || [];

    if (selectedTypes.length === 0) {
      alert("æœªé¸æ“‡è¡Œç‚ºé¡å‹ï¼Œè«‹å›ä¸Šä¸€é å‹¾é¸ã€‚");
      window.location.href = "query.html";
      return;
    }

    startQuiz();
  } catch (err) {
    console.error(err);
    alert("é¡Œç›®è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
  }
}

function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

function selectQuestions() {
  let pool = [];
  selectedTypes.forEach(type => {
    pool.push(...allQuestions.filter(q => Number(q.questionType) === Number(type)));
  });
  return shuffle(pool).slice(0, totalQuestions);
}

function startQuiz() {
  score = 0;
  currentIndex = 0;
  quizQuestions = selectQuestions();
  renderQuestion();
  document.getElementById("score-box").textContent = "";
}

function renderQuestion() {
  const quizForm = document.getElementById("quiz-form");
  quizForm.innerHTML = "";

  const q = quizQuestions[currentIndex];
  const title = document.createElement("h3");
  title.textContent = `${currentIndex + 1}. ${q.question}`;
  quizForm.appendChild(title);

  q.options.forEach((opt, i) => {
    const label = document.createElement("label");
    label.innerHTML = `<input type="radio" name="q${currentIndex}" value="${i}"> ${opt}`;
    quizForm.appendChild(label);
  });
}

function nextQuestion() {
  const selected = document.querySelector(`input[name="q${currentIndex}"]:checked`);
  if (!selected) {
    alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼");
    return;
  }

  const value = Number(selected.value);
  const correct = quizQuestions[currentIndex].correctAnswerIndex;

  if (value === correct) score += 10;
  currentIndex++;

  if (currentIndex >= quizQuestions.length) {
    finishQuiz();
    return;
  }

  renderQuestion();
}

function finishQuiz() {
  const scoreBox = document.getElementById("score-box");
  scoreBox.textContent = `æ‚¨çš„å¾—åˆ†ï¼š${score} / 100`;

  if (score < 60) {
    alert("æœªé” 60 åˆ†ï¼é¡Œç›®å°‡é‡æ–°æ´—ç‰Œä¸¦é‡æ–°é–‹å§‹ã€‚");
    startQuiz();
    return;
  }

  // åˆ†æ•¸é”æ¨™ â†’ å‰å¾€è¡¨å–®é 
  window.location.href = "form.html";
}

document.getElementById("submit-btn").addEventListener("click", nextQuestion);

loadQuestions();
</script>
</body>
</html>
