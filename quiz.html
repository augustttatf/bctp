<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>學習單 Quiz</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { text-align: center; }
  .quiz-question { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
  label { display: block; margin: 5px 0; }
  #result-container { display: none; margin-top: 20px; text-align: center; }
  button { padding: 8px 16px; border-radius: 5px; border: none; background: #4CAF50; color: white; cursor: pointer; }
  button:hover { background: #45a049; }
</style>
</head>
<body>
<h1>學習單 Quiz</h1>

<form id="quiz-form">
  <div id="quiz-questions"></div>
  <button type="submit">提交答案</button>
</form>

<div id="result-container">
  <p id="score-text"></p>
  <button id="go-reflection">進入反思表單</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() { 
    const selectedBehaviors = JSON.parse(localStorage.getItem('selectedBehaviors') || '[]');

    if(selectedBehaviors.length === 0){
        alert('未偵測到勾選行為，請返回查詢頁重新勾選！');
        window.location.href = 'query.html';
        return;
    }

    // ======== 題庫 ========
    const ALL_QUESTIONS = [
        // 在這裡貼入你的完整 40 題 ALL_QUESTIONS
    ];

    const QUESTIONS_BY_BEHAVIOR = {
        "physical-injury": ALL_QUESTIONS.slice(30, 40),
        "online-slander": ALL_QUESTIONS.slice(20, 30),
        "money-extortion": ALL_QUESTIONS.slice(10, 20),
        "psychological-damage": ALL_QUESTIONS.slice(0, 10)
    };

    function selectRandomQuestions(behaviors, totalQuestions=10){
        const perBehavior = Math.floor(totalQuestions / behaviors.length);
        const remainder = totalQuestions % behaviors.length;
        let selected = [];

        behaviors.forEach((b,i)=>{
            const questions = QUESTIONS_BY_BEHAVIOR[b] || [];
            const count = perBehavior + (i < remainder ? 1 : 0);
            const shuffled = questions.sort(()=>Math.random()-0.5).slice(0,count);
            selected = selected.concat(shuffled);
        });

        return selected.sort(()=>Math.random()-0.5);
    }

    const quizQuestions = selectRandomQuestions(selectedBehaviors, 10);
    const quizContainer = document.getElementById('quiz-questions');
    const resultContainer = document.getElementById('result-container');
    const scoreText = document.getElementById('score-text');
    const goReflectionBtn = document.getElementById('go-reflection');

    // ======== 渲染題目 ========
    quizQuestions.forEach((q,index)=>{
        const questionDiv = document.createElement('div');
        questionDiv.className = 'quiz-question';
        let html = `<p><strong>Q${index+1}:</strong> ${q.question}</p>`;
        q.options.forEach((opt,i)=>{
            html += `<label><input type="radio" name="q${index}" value="${i}"> ${opt}</label>`;
        });
        questionDiv.innerHTML = html;
        quizContainer.appendChild(questionDiv);
    });

    // ======== 提交答案 ========
    const quizForm = document.getElementById('quiz-form');
    quizForm.addEventListener('submit', function(e){
        e.preventDefault();
        let score = 0;
        quizQuestions.forEach((q,index)=>{
            const selected = quizForm.querySelector(`input[name="q${index}"]:checked`);
            if(selected && parseInt(selected.value) === q.correctAnswerIndex){
                score++;
            }
        });

        quizForm.style.display = 'none';
        resultContainer.style.display = 'block';
        const passScore = Math.ceil(quizQuestions.length * 0.6);
        scoreText.textContent = `你答對了 ${score} 題 / ${quizQuestions.length} 題。${score >= passScore ? '已達及格標準！' : '未達及格標準。'}`;
    });

    // ======== 進入反思表單 ========
    goReflectionBtn.addEventListener('click', ()=>{
        const score = quizQuestions.reduce((acc,q,index)=>{
            const selected = quizForm.querySelector(`input[name="q${index}"]:checked`);
            return acc + (selected && parseInt(selected.value) === q.correctAnswerIndex ? 1 : 0);
        }, 0);

        if(score >= Math.ceil(quizQuestions.length * 0.6)){
            window.location.href='reflection.html';
        } else {
            alert('未達及格標準，請重新作答以進入反思表單。');
        }
    });
});
</script>
</body>
</html>
