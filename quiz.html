<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>少年事件測驗</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .quiz-question { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #result-container { display: none; margin-top: 20px; }
        #go-reflection { margin-top: 10px; padding: 5px 15px; }
        label { display: block; margin-top: 5px; }
        #selected-behaviors { margin-bottom: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>少年事件測驗</h1>
    <p id="selected-behaviors"></p>
    <form id="quiz-form">
        <div id="quiz-questions"></div>
        <button type="submit">提交答案</button>
    </form>

    <div id="result-container">
        <p id="score-text"></p>
        <button id="go-reflection">進入反思表單</button>
    </div>

    <script src="quiz.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const selectedBehaviors = JSON.parse(localStorage.getItem('selectedBehaviors') || '[]');

            // 顯示勾選的行為
            const displayBehaviors = document.getElementById('selected-behaviors');
            displayBehaviors.textContent = '您勾選的行為： ' + JSON.stringify(selectedBehaviors);

            if(selectedBehaviors.length === 0){
                alert('未偵測到勾選行為，請返回查詢頁重新勾選！');
                window.location.href = 'query.html';
                return;
            }

            // 確保 quizQuestions 有題目
            if(typeof quizQuestions === 'undefined' || quizQuestions.length === 0){
                alert('目前沒有可出題的題目，請返回查詢頁重新選擇行為！');
                window.location.href = 'query.html';
                return;
            }

            const quizForm = document.getElementById('quiz-form');
            const quizContainer = document.getElementById('quiz-questions');
            const resultContainer = document.getElementById('result-container');
            const scoreText = document.getElementById('score-text');
            const goReflectionBtn = document.getElementById('go-reflection');

            // 渲染題目
            quizQuestions.forEach((q,index)=>{
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                let html = `<p><strong>Q${index+1}:</strong> ${q.question}</p>`;
                q.options.forEach((opt,i)=>{
                    html += `<label><input type="radio" name="q${index}" value="${i}"> ${opt}</label>`;
                });
                questionDiv.innerHTML = html;
                quizContainer.appendChild(questionDiv);
            });

            // 提交答案
            quizForm.addEventListener('submit', function(e){
                e.preventDefault();
                let score = 0;
                quizQuestions.forEach((q,index)=>{
                    const selected = quizForm.querySelector(`input[name="q${index}"]:checked`);
                    if(selected && parseInt(selected.value) === q.correctAnswerIndex){
                        score++;
                    }
                });

                quizForm.style.display = 'none';
                resultContainer.style.display = 'block';

                const passScore = Math.ceil(quizQuestions.length * 0.6);
                scoreText.textContent = `你答對了 ${score} 題 / ${quizQuestions.length} 題。${score >= passScore ? '已達及格標準！' : '未達及格標準。'}`;
            });

            // 進入反思表單
            goReflectionBtn.addEventListener('click', ()=>{
                const score = quizQuestions.reduce((acc,q,index)=>{
                    const selected = quizForm.querySelector(`input[name="q${index}"]:checked`);
                    return acc + (selected && parseInt(selected.value) === q.correctAnswerIndex ? 1 : 0);
                }, 0);

                const passScore = Math.ceil(quizQuestions.length * 0.6);
                if(score >= passScore){
                    window.location.href='reflection.html';
                } else {
                    alert('未達及格標準，請重新作答以進入反思表單。');
                }
            });
        });
    </script>
</body>
</html>
